<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vue3的响应系统分析 | 我的博客</title>
    <meta name="description" content="A VitePress site">
    <link rel="stylesheet" href="/blog/assets/style.b948ed94.css">
    <link rel="modulepreload" href="/blog/assets/chunks/AlgoliaSearchBox.ef6e603b.js">
    <link rel="modulepreload" href="/blog/assets/app.2233c548.js">
    <link rel="modulepreload" href="/blog/assets/vue3-analysis_reactivity_vue3的响应系统分析.md.1fa66402.lean.js">
    
    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script>
  <script>window.addEventListener("load",function(o){let e=new MutationObserver(()=>{mediumZoom(document.querySelectorAll("img"),{background:"rgba(0, 0, 0, 0.5)"})}),t={childList:!0,subtree:!0};e.observe(document.getElementById("app"),t)});</script>
  <meta name="twitter:title" content="vue3的响应系统分析 | 我的博客">
  <meta property="og:title" content="vue3的响应系统分析 | 我的博客">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/blog/" aria-label="我的博客, back to home" data-v-675d8756 data-v-cc01ef16><!----> 我的博客</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><nav class="nav-links" data-v-675d8756 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/blog/javascript/void" data-v-b8818f8c>JavaScript <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>源码解析</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item active" href="/blog/vue3-analysis/structure" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Vue3源码解析</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/blog/vue-router/preface" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>vue-router源码解析</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/blog/pinia/preface" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>pinia源码解析</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/MAXLZ1/blog" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>Github <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav></div><!--[--><!--[--><div class="algolia-search-box" id="docsearch"></div><!--]--><!--]--></header><aside class="sidebar" data-v-83e92a68><nav class="nav-links nav" data-v-83e92a68 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/blog/javascript/void" data-v-b8818f8c>JavaScript <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>源码解析</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item active" href="/blog/vue3-analysis/structure" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Vue3源码解析</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/blog/vue-router/preface" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>vue-router源码解析</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/blog/pinia/preface" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>pinia源码解析</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/MAXLZ1/blog" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>Github <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue3-analysis/structure">源码目录结构</a><!----></li><li class="sidebar-link"><p class="sidebar-link-item">响应系统</p><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue3-analysis/reactivity/副作用函数与响应式数据">副作用函数与响应式数据</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item active" href="/blog/vue3-analysis/reactivity/vue3的响应系统分析">vue3的响应系统分析</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#effect">effect</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#reactiveeffect">ReactiveEffect</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#run">run</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#stop">stop</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#依赖收集">依赖收集</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#触发依赖">触发依赖</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue3-analysis/reactivity/effectScope">effectScope</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><h1 id="vue3的响应系统分析" tabindex="-1">vue3的响应系统分析 <a class="header-anchor" href="#vue3的响应系统分析" aria-hidden="true">#</a></h1><div class="tip custom-block"><p class="custom-block-title">TIP</p><p><code>vue3</code>的响应式处理主要集中在<code>packages/reactivity/src/effect.ts</code>文件中。</p></div><h2 id="effect" tabindex="-1">effect <a class="header-anchor" href="#effect" aria-hidden="true">#</a></h2><p>在<code>vue3</code>中，会使用一个<code>effect</code>方法注册副作用函数。为什么要注册副作用函数呢？</p><p>如果响应式数据更新，我们希望副作用函数中的相关数据也能同步更新。要实现这种效果，就需要我们做两个工作：</p><ul><li>在<strong>读取</strong>响应式数据时，收集副作用函数。</li><li>在<strong>设置</strong>响应式数据时，触发副作用函数。</li></ul><p>那么我们如何在设置响应式数据时，触发相关的副作用函数呢？这就需要我们在收集副作用函数时，使用某种数据结构把他暂存起来，等到需要到他的时候，就可以取出来。</p><p><code>effect</code>的作用就是将我们注册的副作用函数暂存。下面我们来看<code>effect</code>的实现：</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">effect</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">,</span>
  options<span class="token operator">?</span><span class="token operator">:</span> ReactiveEffectOptions
<span class="token punctuation">)</span><span class="token operator">:</span> ReactiveEffectRunner <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fn <span class="token keyword">as</span> ReactiveEffectRunner<span class="token punctuation">)</span><span class="token punctuation">.</span>effect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fn <span class="token operator">=</span> <span class="token punctuation">(</span>fn <span class="token keyword">as</span> ReactiveEffectRunner<span class="token punctuation">)</span><span class="token punctuation">.</span>effect<span class="token punctuation">.</span>fn
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> _effect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactiveEffect</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">extend</span><span class="token punctuation">(</span>_effect<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>scope<span class="token punctuation">)</span> <span class="token function">recordEffectScope</span><span class="token punctuation">(</span>_effect<span class="token punctuation">,</span> options<span class="token punctuation">.</span>scope<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options <span class="token operator">||</span> <span class="token operator">!</span>options<span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> runner <span class="token operator">=</span> _effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>_effect<span class="token punctuation">)</span> <span class="token keyword">as</span> ReactiveEffectRunner
  runner<span class="token punctuation">.</span>effect <span class="token operator">=</span> _effect
  <span class="token keyword">return</span> runner
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><code>effect</code>可以接收两个参数，其中第二个参数为可选参数，可以不传。第一个参数是一个副作用函数<code>fn</code>，第二个参数是个对象，该对象可以有如下属性：</p><ul><li><code>lazy</code>：<code>boolean</code>，是否懒加载，如果是<code>true</code>，调用<code>effect</code>不会立即执行监听函数，需要用户手动执行</li><li><code>scheduler</code>：一个调度函数，如果存在调度函数，在触发依赖时，执行该调度函数</li><li><code>scope</code>：一个<code>EffectScope</code>作用域对象</li><li><code>allowRecurse</code>：<code>boolean</code>，允许递归</li><li><code>onStop</code>：<code>effect</code>被停止时的钩子</li></ul><p>在<code>effect</code>中会首先检查<code>fn.effect</code>属性，如果存在<code>fn.effect</code>，那么说明<code>fn</code>已经被<code>effect</code>处理过了，然后使用<code>fn.effect.fn</code>作为<code>fn</code>。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fn <span class="token keyword">as</span> ReactiveEffectRunner<span class="token punctuation">)</span><span class="token punctuation">.</span>effect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fn <span class="token operator">=</span> <span class="token punctuation">(</span>fn <span class="token keyword">as</span> ReactiveEffectRunner<span class="token punctuation">)</span><span class="token punctuation">.</span>effect<span class="token punctuation">.</span>fn
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> runner1 <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
<span class="token keyword">const</span> runner2 <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>runner1<span class="token punctuation">)</span>

runner1<span class="token punctuation">.</span>effect<span class="token punctuation">.</span>fn <span class="token operator">===</span> fn <span class="token comment">// true</span>
runner2<span class="token punctuation">.</span>effect<span class="token punctuation">.</span>fn <span class="token operator">===</span> fn <span class="token comment">// true</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>然后<code>new</code>了一个<code>ReactiveEffect</code>对象。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">const</span> _effect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactiveEffect</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>接着如果存在<code>option</code>对象的话，会将<code>options</code>，合并到<code>_effect</code>中。如果存在<code>options.scope</code>，会调用<code>recordEffectScope</code>将<code>_effect</code>放入<code>options.scope</code>。如果不存在<code>options</code>或<code>options.lazy === false</code>，那么会执行<code>_effect.run()</code>，进行依赖的收集。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">extend</span><span class="token punctuation">(</span>_effect<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>scope<span class="token punctuation">)</span> <span class="token function">recordEffectScope</span><span class="token punctuation">(</span>_effect<span class="token punctuation">,</span> options<span class="token punctuation">.</span>scope<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options <span class="token operator">||</span> <span class="token operator">!</span>options<span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  _effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>最后，会将<code>_effect.run</code>中的<code>this</code>指向它本身，这样做的目的是用户在主动执行<code>runner</code>时，<code>this</code>指针指向的是<code>_effect</code>对象，然后将<code>_effect</code>作为<code>runner</code>的<code>effect</code>属性，并将<code>runner</code>返回。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">const</span> runner <span class="token operator">=</span> _effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>_effect<span class="token punctuation">)</span> <span class="token keyword">as</span> ReactiveEffectRunner
runner<span class="token punctuation">.</span>effect <span class="token operator">=</span> _effect
<span class="token keyword">return</span> runner
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在<code>effect</code>中创建了一个<code>ReactiveEffect</code>对象，这个<code>ReactiveEffect</code>是什么呢？接下来继续看<code>ReactiveEffect</code>的实现。</p><h2 id="reactiveeffect" tabindex="-1">ReactiveEffect <a class="header-anchor" href="#reactiveeffect" aria-hidden="true">#</a></h2><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ReactiveEffect<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  active <span class="token operator">=</span> <span class="token boolean">true</span>
  deps<span class="token operator">:</span> Dep<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  parent<span class="token operator">:</span> ReactiveEffect <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> <span class="token keyword">undefined</span>

  computed<span class="token operator">?</span><span class="token operator">:</span> ComputedRefImpl<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>
  allowRecurse<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>

  onStop<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
  <span class="token comment">// dev only</span>
  onTrack<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>event<span class="token operator">:</span> DebuggerEvent<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
  <span class="token comment">// dev only</span>
  onTrigger<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>event<span class="token operator">:</span> DebuggerEvent<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">public</span> <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">,</span>
    <span class="token keyword">public</span> scheduler<span class="token operator">:</span> EffectScheduler <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    scope<span class="token operator">?</span><span class="token operator">:</span> EffectScope
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">recordEffectScope</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> scope<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> parent<span class="token operator">:</span> ReactiveEffect <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> activeEffect
    <span class="token keyword">let</span> lastShouldTrack <span class="token operator">=</span> shouldTrack
    <span class="token keyword">while</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      parent <span class="token operator">=</span> parent<span class="token punctuation">.</span>parent
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> activeEffect
      activeEffect <span class="token operator">=</span> <span class="token keyword">this</span>
      shouldTrack <span class="token operator">=</span> <span class="token boolean">true</span>

      trackOpBit <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">++</span>effectTrackDepth

      <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTrackDepth <span class="token operator">&lt;=</span> maxMarkerBits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">initDepMarkers</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">cleanupEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTrackDepth <span class="token operator">&lt;=</span> maxMarkerBits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">finalizeDepMarkers</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      trackOpBit <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">--</span>effectTrackDepth

      activeEffect <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent
      shouldTrack <span class="token operator">=</span> lastShouldTrack
      <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">undefined</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">cleanupEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>onStop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p><code>ReactiveEffect</code>是使用<code>es6 class</code>定义的一个类。它的构造器可以接受三个参数：<code>fn</code>（副作用函数）、<code>scheduler</code>（调度器）、<code>scope</code>（一个<code>EffectScope</code>作用域对象），在构造器中调用了一个<code>recordEffectScope</code>方法，这个方法会将当前<code>ReactiveEffect</code>对象（<code>this</code>）放入对应的<code>EffectScope</code>作用域（<code>scope</code>）中。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token function">constructor</span><span class="token punctuation">(</span>
  <span class="token keyword">public</span> <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">,</span>
  <span class="token keyword">public</span> scheduler<span class="token operator">:</span> EffectScheduler <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  scope<span class="token operator">?</span><span class="token operator">:</span> EffectScope
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">recordEffectScope</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> scope<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>ReactiveEffect</code>中有两个方法：<code>run</code>、<code>stop</code>。</p><h3 id="run" tabindex="-1">run <a class="header-anchor" href="#run" aria-hidden="true">#</a></h3><p>在<code>run</code>的执行过程中，会首先判断<code>ReactiveEffect</code>的激活状态（<code>active</code>），如果未激活（<code>this.active === false</code>），那么会立马执行<code>this.fn</code>并返回他的执行结果。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>然后声明了两个变量：<code>parent</code>（默认<code>activeEffect</code>）、<code>lastShouldTrack</code>（默认<code>shouldTrack</code>，一个全局变量，默认为<code>true</code>）。紧接着会使用<code>while</code>循环寻找<code>parent.parent</code>，一旦<code>parent</code>与<code>this</code>相等，立即结束循环。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">let</span> parent<span class="token operator">:</span> ReactiveEffect <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> activeEffect
<span class="token keyword">let</span> lastShouldTrack <span class="token operator">=</span> shouldTrack
<span class="token keyword">while</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  parent <span class="token operator">=</span> parent<span class="token punctuation">.</span>parent
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>紧接着把<code>activeEffect</code>赋值给<code>this.parent</code>，把<code>this</code>赋值给<code>this.parent</code>。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token comment">// 设置当前的parent为上一个activeEffect</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> activeEffect
  <span class="token comment">// 设置activeEffect为当前ReactiveEffect实例，activeEffect是个全局变量</span>
  activeEffect <span class="token operator">=</span> <span class="token keyword">this</span>
  shouldTrack <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这样做的目的是，建立一个嵌套<code>effect</code>的关系，来看下面一个例子：</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>a<span class="token punctuation">)</span>
  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>a<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>当执行第一层<code>_effect.run</code>时，因为默认的<code>activeEffect</code>为<code>undefined</code>，所以第一层<code>effect</code>中的<code>_effect.parent=undefined</code>，紧接着把<code>this</code>赋值给<code>activeEffect</code>，这时<code>activeEffect</code>指向的第一层的<code>_effect</code>。</p><p>在第一层中的<code>_effect.run</code>执行过程中，最后会执行<code>this.fn()</code>，在执行<code>this.fn()</code>的过程中，会创建第二层<code>effect</code>的<code>ReactiveEffect</code>对象，然后执行<code>_effect.run</code>，因为在第一层中<code>_effect.run</code>运行过程中，已经将第一层的<code>_effect</code>赋给了<code>activeEffect</code>，所以第二层中的<code>_effect.parent</code>指向了第一层的<code>_effect</code>，紧接着又将第二次的<code>_effect</code>赋给了<code>activeEffect</code>。这样以来第一层<code>effect</code>与第二层<code>effect</code>就建立了联系。</p><p>当与父<code>effect</code>建立联系后，有这么一行代码：</p><div class="language-ts line-numbers-mode"><pre><code>trackOpBit <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">++</span>effectTrackDepth
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其中<code>effectTrackDepth</code>是个全局变量为<code>effect</code>的深度，层数从1开始计数，<code>trackOpBit</code>使用二进制标记依赖收集的状态（如<code>00000000000000000000000000000010</code>表示所处深度为1）。</p><p>紧接着会进行一个条件的判断：如果<code>effectTrackDepth</code>未超出最大标记位（<code>maxMarkerBits = 30</code>），会调用<code>initDepMarkers</code>方法将<code>this.deps</code>中的所有<code>dep</code>标记为已经被<code>track</code>的状态；否则使用<code>cleanupEffect</code>移除<code>deps</code>中的所有<code>dep</code>。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>effectTrackDepth <span class="token operator">&lt;=</span> maxMarkerBits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">initDepMarkers</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token function">cleanupEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这里为什么要标记已经被<code>track</code>的状态或直接移除所有<code>dep</code>？我们来看下面一个例子：</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> str<span class="token operator">:</span> <span class="token string">&#39;objStr&#39;</span><span class="token punctuation">,</span> flag<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> c <span class="token operator">=</span> obj<span class="token punctuation">.</span>flag <span class="token operator">?</span> obj<span class="token punctuation">.</span>str <span class="token operator">:</span> <span class="token string">&#39;no found&#39;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

obj<span class="token punctuation">.</span>flag <span class="token operator">=</span> <span class="token boolean">false</span>

obj<span class="token punctuation">.</span>str <span class="token operator">=</span> <span class="token string">&#39;test&#39;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在首次<code>track</code>时，<code>targetMap</code>结构如下（<code>targetMap</code>在下文中有介绍）： <img src="/blog/assets/effect-flow1.520f9dd6.png" alt=""></p><p>这时<code>targetMap[toRaw(obj)]</code>（这里<code>targetMap</code>的键是<code>obj</code>的原始对象）中分别保存着<code>str</code>、<code>flag</code>共两份依赖。当执行<code>obj.flag=false</code>后，会触发<code>flag</code>对应的依赖，此时打印<code>not found</code>。</p><p>当<code>obj.flag</code>变为<code>false</code>之后，副作用函数就不会受<code>obj.str</code>的影响了，之后的操作，无论<code>obj.str</code>如何变化，都不应该影响到副作用函数。这里标记<code>dep</code>为已被<code>track</code>或移除<code>dep</code>的作用就是实现这种效果。由于<code>obj.flag</code>的修改，会触发<code>flag</code>对应的副作用函数（执行<code>run</code>函数），此时<code>this.deps</code>中保存着<code>str</code>与<code>flag</code>的对应的两份依赖，所以调用<code>initDepMarkers</code>后，会将这两份依赖标记为已收集，当<code>this.fn()</code>执行完毕后，会根据<code>dep</code>某些属性，将<code>str</code>所对应的依赖移除。这样无论修改<code>str</code>为和值，都没有对应的依赖触发。</p><p><strong>所以<code>initDepMarkers（在finally移除）/cleanupEffect</code>的作用是移除多余的依赖。</strong></p><p>回到<code>run</code>函数中，最后需要执行<code>this.fn()</code>，并将结果返回。这样就可以进行依赖的收集。在<code>return fn()</code>之后继续进入<code>finally</code>，在<code>finally</code>中需要恢复一些状态：<code>finalizeDepMarkers</code>根据一些状态移除多余的依赖、将<code>effectTrackDepth</code>回退一层，<code>activeEffect</code>指向当前<code>ReactiveEffect</code>的<code>parent</code>、<code>shouldTrack = lastShouldTrack</code>、<code>this.parent</code>置为<code>undefined</code></p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTrackDepth <span class="token operator">&lt;=</span> maxMarkerBits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">finalizeDepMarkers</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  trackOpBit <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">--</span>effectTrackDepth

  activeEffect <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent
  shouldTrack <span class="token operator">=</span> lastShouldTrack
  <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">undefined</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><code>run</code>函数的作用就是会调用<code>fn</code>，并返回其结果，在执行<code>fn</code>的过程中会命中响应式对象的某些拦截操作，在拦截过程中进行依赖的收集。</p><h3 id="stop" tabindex="-1">stop <a class="header-anchor" href="#stop" aria-hidden="true">#</a></h3><p>当调用<code>stop</code>函数后，会调用<code>cleanupEffect</code>将<code>ReactiveEffect</code>中所有的依赖删除，然后执行<code>onStop</code>钩子，最后将<code>this.active</code>置为<code>false</code>。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">cleanupEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>onStop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="依赖收集" tabindex="-1">依赖收集 <a class="header-anchor" href="#依赖收集" aria-hidden="true">#</a></h2><p>通过上面对<code>effect</code>的分析，在<code>effect</code>中如果未设置<code>options.lazy = false</code>的话，会直接执行<code>_effect.run()</code>，而在<code>run()</code>方法中最后最终会调用副作用函数<code>fn</code>。在<code>fn</code>的执行过程中，会读取某个响应式数据，而我们的响应式数据是被<code>Proxy</code>代理过的，一旦读取响应式数据的某个属性，就会触发<code>Proxy</code>的<code>get</code>操作（不一定是<code>get</code>，这里以<code>get</code>为例进行说明）。在拦截过程中会触发一个<code>track</code>函数。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token operator">:</span> object<span class="token punctuation">,</span> type<span class="token operator">:</span> TrackOpTypes<span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrack <span class="token operator">&amp;&amp;</span> activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>dep <span class="token operator">=</span> <span class="token function">createDep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> eventInfo <span class="token operator">=</span> __DEV__
      <span class="token operator">?</span> <span class="token punctuation">{</span> effect<span class="token operator">:</span> activeEffect<span class="token punctuation">,</span> target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key <span class="token punctuation">}</span>
      <span class="token operator">:</span> <span class="token keyword">undefined</span>

    <span class="token function">trackEffects</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> eventInfo<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><code>track</code>函数接收三个参数：<code>target</code>（响应式对象的原始对象）、<code>type</code>（触发依赖操作的方式，有三种取值：<code>TrackOpTypes.GET</code>、<code>TrackOpTypes.HAS</code>、<code>TrackOpTypes.ITERATE</code>）、<code>key</code>（触发依赖收集的<code>key</code>）。</p><p><code>track</code>中一上来就对<code>shouldTrack</code>和<code>activeEffect</code>进行了判断，只有<code>shouldTrack</code>为<code>true</code>且存在<code>activeEffect</code>时才可以进行依赖收集。</p><p>如果可以进行依赖收集的话，会从<code>targetMap</code>中获取<code>target</code>对应的值，这里<code>targetMap</code>保存着所有响应式数据所对应的副作用函数，它是个<code>WeakMap</code>类型的全局变量，<code>WeakMap</code>的键是响应式数据的原始对象<code>target</code>，值是个<code>Map</code>，而<code>Map</code>的键是原始对象的<code>key</code>，<code>Map</code>的值时一个由副作用函数（一个<code>ReactiveEffect</code>实例）组成的<code>Set</code>集合。</p><p>为什么<code>target</code>要使用<code>WeakMap</code>，而不是<code>Map</code>？因为<code>WeakMap</code>的键是弱引用，如果<code>target</code>被销毁后，那么它对应的值<code>Map</code>也会被回收。如果你不了解<code>WeakMap</code>的使用，请参考：<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/WeakMap" target="_blank" rel="noopener noreferrer">MDN</a></p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">type</span> <span class="token class-name">KeyToDepMap</span> <span class="token operator">=</span> Map<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> Dep<span class="token operator">&gt;</span>
<span class="token keyword">const</span> targetMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> KeyToDepMap<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="/blog/assets/targetMap.6a8e9c15.png" alt=""></p><p>如果从<code>targetMap</code>找不到<code>target</code>对应的值，则创建一个<code>Map</code>对象，存入<code>targetMap</code>中。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后从<code>depsMap</code>中获取<code>key</code>对应的副作用集合，如果不存在，则创建一个<code>Set</code>，存入<code>depsMap</code>中。这里创建<code>Set</code>的过程中，会为<code>Set</code>实例添加两个属性：<code>n</code>、<code>w</code>。<code>w</code>表示在副作用函数执行前<code>dep</code>是否已经被收集过了，<code>n</code>表示在当前收集（本次<code>run</code>执行）过程中<code>dep</code>是新收集的。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>dep <span class="token operator">=</span> <span class="token function">createDep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>最后调用<code>trackEffects</code>方法。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">const</span> eventInfo <span class="token operator">=</span> __DEV__
  <span class="token operator">?</span> <span class="token punctuation">{</span> effect<span class="token operator">:</span> activeEffect<span class="token punctuation">,</span> target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key <span class="token punctuation">}</span>
  <span class="token operator">:</span> <span class="token keyword">undefined</span>

<span class="token function">trackEffects</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> eventInfo<span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trackEffects</span><span class="token punctuation">(</span>
  dep<span class="token operator">:</span> Dep<span class="token punctuation">,</span>
  debuggerEventExtraInfo<span class="token operator">?</span><span class="token operator">:</span> DebuggerEventExtraInfo
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> shouldTrack <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTrackDepth <span class="token operator">&lt;=</span> maxMarkerBits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">newTracked</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      dep<span class="token punctuation">.</span>n <span class="token operator">|=</span> trackOpBit <span class="token comment">// set newly tracked</span>
      shouldTrack <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">wasTracked</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 直接判断dep中是否含有activeEffect</span>
    shouldTrack <span class="token operator">=</span> <span class="token operator">!</span>dep<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>activeEffect<span class="token operator">!</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token operator">!</span><span class="token punctuation">)</span>
    activeEffect<span class="token operator">!</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> activeEffect<span class="token operator">!</span><span class="token punctuation">.</span>onTrack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      activeEffect<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">onTrack</span><span class="token punctuation">(</span>
        Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>
          <span class="token punctuation">{</span>
            effect<span class="token operator">:</span> activeEffect<span class="token operator">!</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          debuggerEventExtraInfo
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p><code>trackEffects</code>接收两个参数：<code>dep</code>（<code>ReactiveEffect</code>集合），<code>debuggerEventExtraInfo</code>（开发环境下<code>activeEffect.onTrack</code>钩子所需的参数）。</p><p>在<code>trackEffects</code>中说先声明了一个默认值为<code>false</code>的<code>shouldTrack</code>变量，它代表我们需不需要收集<code>activeEffect</code>。</p><p>如果<code>shouldTrack</code>为<code>true</code>的话，则将<code>activeEffect</code>添加到<code>dep</code>中，同时将<code>dep</code>放入<code>activeEffect.deps</code>中。</p><p><code>shouldTrack</code>的确定和<code>dep</code>的<code>n</code>、<code>w</code>属性密切相关。如果<code>newTracked(dep) === true</code>，说明在本次<code>run</code>方法执行过程中，<code>dep</code>已经被收集过了，<code>shouldTrack</code>不变；如果<code>newTracked(dep) === false</code>，要把<code>dep</code>标记为新收集的，虽然<code>dep</code>在本次收集过程中是新收集的，但它可能在之前的收集过程中已经被收集了，所以<code>shouldTrack</code>的值取决于<code>dep</code>是否在之前已经被收集过了。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token comment">// wasTracked(dep)返回true，意味着dep在之前的依赖收集过程中已经被收集过，或者说在之前run执行过程中已经被收集</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> wasTracked <span class="token operator">=</span> <span class="token punctuation">(</span>dep<span class="token operator">:</span> Dep<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>dep<span class="token punctuation">.</span>w <span class="token operator">&amp;</span> trackOpBit<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>

<span class="token comment">// newTracked(dep)返回true，意味着dep是在本次依赖收集过程中新收集到的，或者说在本次run执行过程中新收集到的</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> newTracked <span class="token operator">=</span> <span class="token punctuation">(</span>dep<span class="token operator">:</span> Dep<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>dep<span class="token punctuation">.</span>n <span class="token operator">&amp;</span> trackOpBit<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这里使用以下例子来说明<code>shouldTrack</code>的确认过程：</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">let</span> sum
<span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> num1<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> num2<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  sum <span class="token operator">=</span> counter<span class="token punctuation">.</span>num1 <span class="token operator">+</span> counter<span class="token punctuation">.</span>num1 <span class="token operator">+</span> counter<span class="token punctuation">.</span>num2
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在上面例子中共经历3次依赖收集的过程。</p><ol><li>第一次因为访问到<code>counter.num1</code>，被<code>counter</code>的<code>get</code>拦截器拦截，因为最开始<code>targetMap</code>是空的，所以在第一次收集过程中会进行初始化，此时<code>targetMap[toRaw(counter)].num1.n/w=0</code>，当决定<code>shouldTrack</code>的值时，因为<code>newTracked(dep)===false</code>，所以<code>shouldTrack=!wasTracked</code>，显然<code>wasTracked(dep)===false</code>，<code>shouldTrack</code>值被确定为<code>true</code>，意味着依赖应该被收集，<code>track</code>执行完成后的<code>targetMap</code>结构为 <img src="/blog/assets/track-flow1.23c0c801.png" alt=""></li><li>第二次同样访问到<code>counter.num1</code>，被<code>counter</code>的<code>get</code>拦截器拦截，并开始收集依赖，但在这次收集过程中，因为<code>newTracked(dep) === true</code>，所以<code>shouldTrack</code>为<code>false</code>，本次不会进行依赖的收集</li><li>第三次访问到<code>counter.num2</code>，过程与第一次相同，当本次<code>track</code>执行完毕后，<code>targetMap</code>结构为 <img src="/blog/assets/track-flow2.1aed82f1.png" alt=""></li><li>3次依赖收集完毕，意味着<code>fn</code>执行完毕，进入<code>finally</code>中，执行<code>finalizeDepMarkers</code>，此时会将<code>_effect.deps</code>中的<code>dep.n</code>恢复至0</li></ol><h2 id="触发依赖" tabindex="-1">触发依赖 <a class="header-anchor" href="#触发依赖" aria-hidden="true">#</a></h2><p>在依赖被收集完成后，一旦响应式数据的某些属性改变后，就会触发对应的依赖。这个触发的过程发生在<code>proxy</code>的<code>set</code>、<code>deleteProperty</code>拦截器、，或集合的<code>get</code>拦截器（拦截<code>clear</code>、<code>add</code>、<code>set</code>等操作）。</p><p>在触发依赖时，会执行一个<code>trigger</code>函数：</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span>
  target<span class="token operator">:</span> object<span class="token punctuation">,</span>
  type<span class="token operator">:</span> TriggerOpTypes<span class="token punctuation">,</span>
  key<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  newValue<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  oldValue<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  oldTarget<span class="token operator">?</span><span class="token operator">:</span> Map<span class="token operator">&lt;</span><span class="token builtin">unknown</span><span class="token punctuation">,</span> <span class="token builtin">unknown</span><span class="token operator">&gt;</span> <span class="token operator">|</span> Set<span class="token operator">&lt;</span><span class="token builtin">unknown</span><span class="token operator">&gt;</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 获取target对相应的所有依赖，一个map对象 </span>
   <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
   <span class="token comment">// 如果没有，说明没有依赖，直接return</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// 获取需要触发的依赖</span>
   <span class="token keyword">let</span> deps<span class="token operator">:</span> <span class="token punctuation">(</span>Dep <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">CLEAR</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// collection being cleared</span>
      <span class="token comment">// trigger all effects for target</span>
      deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>depsMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&#39;length&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      depsMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&#39;length&#39;</span> <span class="token operator">||</span> key <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>newValue <span class="token keyword">as</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// schedule runs for SET | ADD | DELETE</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 获取一些迭代的依赖，如map.keys、map.values、map.entries等</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">case</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">ADD</span><span class="token operator">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMap</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">MAP_KEY_ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIntegerKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">// new index added to array -&gt; length changes</span>
               deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;length&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span>
         <span class="token keyword">case</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">DELETE</span><span class="token operator">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMap</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">MAP_KEY_ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span>
         <span class="token keyword">case</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token operator">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMap</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">const</span> eventInfo <span class="token operator">=</span> __DEV__
           <span class="token operator">?</span> <span class="token punctuation">{</span> target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> oldTarget <span class="token punctuation">}</span>
           <span class="token operator">:</span> <span class="token keyword">undefined</span>

   <span class="token comment">// 开始触发依赖</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">triggerEffects</span><span class="token punctuation">(</span>deps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> eventInfo<span class="token punctuation">)</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">triggerEffects</span><span class="token punctuation">(</span>deps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> effects<span class="token operator">:</span> ReactiveEffect<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> dep <span class="token keyword">of</span> deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            effects<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>dep<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">triggerEffects</span><span class="token punctuation">(</span><span class="token function">createDep</span><span class="token punctuation">(</span>effects<span class="token punctuation">)</span><span class="token punctuation">,</span> eventInfo<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token function">triggerEffects</span><span class="token punctuation">(</span><span class="token function">createDep</span><span class="token punctuation">(</span>effects<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br></div></div><p><code>trigger</code>可接收六个参数：</p><ul><li><code>target</code>：响应式数据的原始对象</li><li><code>type</code>：操作类型。是个枚举类<code>TriggerOpTypes</code>，共有四种操作类型： <ul><li><code>TriggerOpTypes.SET</code>：如<code>obj.xx = xx</code>（修改属性）、<code>map.set(xx, xx)</code>（修改操作不是新增操作）、<code>arr[index] = xx</code>(<code>index &lt; arr.length</code>)、<code>arr.length = 0</code></li><li><code>TriggerOpTypes.ADD</code>：如<code>obj.xx = xx</code>（新增属性）、<code>set.add(xx)</code>、<code>map.set(xx, xx)</code>（新增操作）、<code>arr[index] = xx</code>(<code>index &gt;= arr.length</code>)</li><li><code>TriggerOpTypes.DELETE</code>：如<code>delete obj.xx</code>、<code>set/map.delete(xx)</code></li><li><code>TriggerOpTypes.CLEAR</code>：如<code>map/set.clear()</code></li></ul></li><li><code>key</code>：可选，触发<code>trigger</code>的键，如<code>obj.foo = 1</code>，<code>key</code>为<code>foo</code>。</li><li><code>newValue</code>：可选，新的值，如<code>obj.foo = 1</code>，<code>newValue</code>为<code>1</code>。</li><li><code>oldValue</code>：可选，旧的值，如<code>obj.foo = 1</code>，<code>oldValue</code>为修改前的<code>obj.foo</code>。</li><li><code>oldTarget</code>：可选，旧的原始对象，只在开发模式下有用。</li></ul><p>在<code>trigger</code>中首先要获取<code>target</code>对应的所有依赖<code>depsMap</code>，如果没有的直接<code>return</code>。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>接下来需要根据<code>key</code>与<code>type</code>获取触发的依赖（使用<code>deps</code>存放需要触发的依赖），这里分为如下几个分支：</p><ul><li><code>type === TriggerOpTypes.CLEAR</code>：意味着调用了<code>map/set.clear()</code>，<code>map/set</code>被清空，这时与<code>map/set</code>相关的所有依赖都需要被触发。</li></ul><div class="language-ts line-numbers-mode"><pre><code>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>depsMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><code>key === &#39;length&#39; &amp;&amp; isArray(target)</code>：当操作的的是<code>array</code>的<code>length</code>属性，如<code>arr.length = 1</code>，这时要获取的依赖包括：<code>length</code>属性的依赖以及索引大于等于新的<code>length</code>的依赖。</li></ul><div class="language-ts line-numbers-mode"><pre><code>depsMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&#39;length&#39;</span> <span class="token operator">||</span> key <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>newValue <span class="token keyword">as</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>其他情况： <ul><li>首先从<code>depsMap</code>中获取对应<code>key</code>的依赖，<code>depsMap.get(key)</code>。</li></ul><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// void 0 等价于undefined</span>
 deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>然后再找一些迭代的依赖，如<code>keys、values、entries</code>操作。</li><li><code>TriggerOpTypes.ADD</code>：如果不是数组，获取<code>ITERATE_KEY</code>的依赖，如果是<code>Map</code>获取<code>MAP_KEY_ITERATE_KEY</code>的依赖；如果是数组并且<code>key</code>是索引，获取<code>length</code>对应的依赖</li></ul><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// target不是数组</span>
   deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMap</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">MAP_KEY_ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIntegerKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// key是整数，获取length对应的依赖</span>
   deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;length&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li><code>TriggerOpTypes.DELETE</code>：如果不是数组，获取<code>ITERATE_KEY</code>的依赖，如果是<code>Map</code>获取<code>MAP_KEY_ITERATE_KEY</code>的依赖</li></ul><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMap</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">MAP_KEY_ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li><code>TriggerOpTypes.SET</code>：如果是<code>Map</code>，获取<code>ITERATE_KEY</code>的依赖</li></ul><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMap</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul><p>这里简单介绍下<code>ITERATE_KEY</code>和<code>MAP_KEY_ITERATE_KEY</code>存储的依赖是由什么操作引起的</p><p><code>ITERATE_KEY</code>中的依赖是由这些操作触发进行收集：获取集合的<code>size</code>、集合的<code>forEach</code>操作、集合的迭代操作（包括<code>keys</code>（非Map）、<code>values</code>、<code>entries</code>、<code>Symbol.iterator</code>（<code>for...of</code>））</p><p><code>MAP_KEY_ITERATE_KEY</code>中的依赖的由<code>map.keys()</code>触发进行收集。</p><p>对应上面其他情况中的几个分支：</p><ul><li>如果对响应式数据的改动是一种新增操作的话，受影响的操作有：集合的<code>size</code>、集合的<code>forEach</code>、集合的迭代操作。</li><li>如果改动是删除操作，受影响的操作有：集合的<code>size</code>、集合的<code>forEach</code>、集合的迭代操作。</li><li>如果改动是修改操作，因为只有<code>map.set()</code>可以实现修改集合的操作，所以受影响的操作只有<code>Map</code>的迭代操作和<code>forEach</code></li></ul><p>当收集完需要触发的依赖，下一步就是要触发依赖：</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token function">triggerEffects</span><span class="token punctuation">(</span>deps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> eventInfo<span class="token punctuation">)</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
     <span class="token function">triggerEffects</span><span class="token punctuation">(</span>deps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token keyword">const</span> effects<span class="token operator">:</span> ReactiveEffect<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> dep <span class="token keyword">of</span> deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     effects<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>dep<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">triggerEffects</span><span class="token punctuation">(</span><span class="token function">createDep</span><span class="token punctuation">(</span>effects<span class="token punctuation">)</span><span class="token punctuation">,</span> eventInfo<span class="token punctuation">)</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
   <span class="token function">triggerEffects</span><span class="token punctuation">(</span><span class="token function">createDep</span><span class="token punctuation">(</span>effects<span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>这里有两个分支：</p><ul><li>如果<code>deps.length</code>为1，且存在<code>des[0]</code>，则调用<code>triggerEffects(deps[0])</code></li><li>否则将遍历<code>deps</code>并解构，将每一个<code>effect</code>放入一个<code>effects</code>中，然后在调用<code>triggerEffects</code>时，利用<code>Set</code>去重：<code>triggerEffects(createDep(effects))</code></li></ul><p><code>triggerEffects</code>函数可以接收两个参数：<code>dep</code>一个数组或Set集合，保存着需要触发的依赖、<code>debuggerEventExtraInfo</code>在开发环境下，<code>effect.onTrigger</code>所需的一些信息。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">triggerEffects</span><span class="token punctuation">(</span>
  dep<span class="token operator">:</span> Dep <span class="token operator">|</span> ReactiveEffect<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  debuggerEventExtraInfo<span class="token operator">?</span><span class="token operator">:</span> DebuggerEventExtraInfo
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> effect <span class="token keyword">of</span> <span class="token function">isArray</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span> <span class="token operator">?</span> dep <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>dep<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>effect <span class="token operator">!==</span> activeEffect <span class="token operator">||</span> effect<span class="token punctuation">.</span>allowRecurse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> effect<span class="token punctuation">.</span>onTrigger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        effect<span class="token punctuation">.</span><span class="token function">onTrigger</span><span class="token punctuation">(</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span> effect <span class="token punctuation">}</span><span class="token punctuation">,</span> debuggerEventExtraInfo<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>scheduler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        effect<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>在<code>triggerEffects</code>中，会遍历<code>dep</code>，如果<code>dep</code>中的<code>effect</code>不是当前活跃的<code>effect</code>（<code>activeEffect</code>）或<code>effect.allowRecurse</code>为<code>true</code>，则会根据是否有<code>effect.scheduler</code>，执行<code>effect.scheduler</code>或<code>effect.run</code>。 至此，依赖触发过程结束。</p><p>接下来详细看下在<code>this.fn()</code>执行完毕后，多余的依赖是如何根据<code>n</code>、<code>w</code>属性移除的（此处值只考虑深度在31层以内的，超出31（包含31）层会直接调用<code>cleanupEffect</code>方法删除，比较简单，此处不进行详细说明）： 我们还是以前面的例子来分析：</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> str<span class="token operator">:</span> <span class="token string">&#39;objStr&#39;</span><span class="token punctuation">,</span> flag<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> c <span class="token operator">=</span> obj<span class="token punctuation">.</span>flag <span class="token operator">?</span> obj<span class="token punctuation">.</span>str <span class="token operator">:</span> <span class="token string">&#39;no found&#39;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

obj<span class="token punctuation">.</span>flag <span class="token operator">=</span> <span class="token boolean">false</span>

obj<span class="token punctuation">.</span>str <span class="token operator">=</span> <span class="token string">&#39;test&#39;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol><li><code>effect</code>执行过程中，创建<code>ReactiveEffect</code>实例，这里以<code>_effect</code>表示，因为未指定<code>lazy</code>，所以会执行<code>_effect.run()</code></li><li>执行<code>this.fn()</code>，在<code>fn</code>执行过程中会访问到<code>obj</code>的<code>flag</code>和<code>str</code>属性，从而被<code>obj</code>的<code>get</code>拦截器进行拦截，在拦截过程中会调用<code>track</code>进行依赖的收集，<code>this.fn()</code>执行完毕后<code>targetMap</code>结构如下 <img src="/blog/assets/effect-flow1.520f9dd6.png" alt=""></li><li>然后进入<code>finally</code>，执行<code>finalizeDepMarkers</code>，因为<code>wasTracked(dep)</code>为<code>false</code>，所以不会删除依赖，但会执行<code>dep.n &amp;= ~trackOpBit</code>，清除比特位。最终<code>targetMap</code>结构为： <img src="/blog/assets/effect-flow2.e3b99f79.png" alt=""></li><li>当执行<code>obj.flag = false</code>时，会触发<code>flag</code>属性对应的依赖，执行<code>trigger</code>，在<code>trigger</code>中获取<code>flag</code>对应的依赖<code>set1</code>，然后调用<code>triggerEffects</code>，在<code>triggerEffects</code>中，执行<code>_effect.run</code>。</li><li>在这次<code>run</code>执行过程中，会将<code>_effect.deps</code>中的依赖集合都标记为已收集状态： <img src="/blog/assets/effect-flow3.e69eb122.png" alt=""></li><li>然后执行<code>this.fn()</code>，同样执行<code>fn</code>的过程中，被<code>obj</code>的<code>get</code>拦截器拦截，不过这次只拦截了<code>flag</code>属性。在<code>trackEffects</code>中检测到<code>newTracked(dep) === false</code>（此处<code>dep</code>就是<code>set1</code>），所以执行<code>dep.n |= trackOpBit</code>操作，将<code>set1</code>标记为本轮收集过程中新的依赖，又因为<code>wasTracked(dep) === true</code>，所以<code>shouldTrack</code>为<code>false</code>，本次不会收集依赖。至此，<code>targetMap</code>结构为： <img src="/blog/assets/effect-flow4.ed9884fb.png" alt=""></li><li>当<code>this.fn()</code>执行完毕，进入<code>finally</code>，执行<code>finalizeDepMarkers</code>。在<code>finalizeDepMarkers</code>中会遍历<code>effect.deps</code>，根据<code>n</code>、<code>w</code>属性移除依赖。</li><li>首先判断<code>set1</code>，因为<code>wasTracked(dep) === true</code>、<code>newTracked(dep) === true</code>，所以执行<code>deps[ptr++] = dep</code>，将<code>set1</code>放在<code>deps</code>索引为0的位置，同时<code>ptr</code>自增1，然后执行<code>dep.w &amp;= ~trackOpBit</code>、<code>dep.n &amp;= ~trackOpBit</code>。最终<code>set1.n/w = 0</code></li><li>接着判断<code>set2</code>，因为<code>wasTracked(dep) === true</code>、<code>newTracked(dep) === false</code>，所以执行<code>dep.delete(effect)</code>，将<code>_effect</code>从<code>set2</code>中删除，然后执行<code>dep.w &amp;= ~trackOpBit</code>、<code>dep.n &amp;= ~trackOpBit</code>。最终<code>set2.n/w = 0</code>，<code>set2</code>中无依赖。</li><li>遍历完毕，执行<code>deps.length = ptr</code>（<code>ptr</code>此时为1）。也就是说把<code>set2</code>从<code>deps</code>中移除了。</li><li><code>finally</code>执行完毕后，<code>targetMap</code>结构为： <img src="/blog/assets/effect-flow5.2e0c5e17.png" alt=""> 可以看到<code>str</code>对应的依赖已经没有了。</li><li>当执行<code>obj.str = &#39;test&#39;</code>时，触发<code>trigger</code>函数，但此时在<code>targetMap</code>中已经没有<code>str</code>对应的依赖了，所以在<code>trigger</code>中直接<code>return</code>，结束。</li></ol></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-07c132fc><div class="edit" data-v-07c132fc><div class="edit-link" data-v-07c132fc data-v-1ed99556><a class="link" href="https://github.com/MAXLZ1/blog/edit/main/docs/vue3-analysis/reactivity/vue3的响应系统分析.md" target="_blank" rel="noopener noreferrer" data-v-1ed99556>纠正文档 <svg class="icon outbound icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-1ed99556><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="updated" data-v-07c132fc><!----></div></footer><div class="next-and-prev-link" data-v-7eddb2c4 data-v-38ede35f><div class="container" data-v-38ede35f><div class="prev" data-v-38ede35f><a class="link" href="/blog/vue3-analysis/reactivity/副作用函数与响应式数据" data-v-38ede35f><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-prev" data-v-38ede35f><path d="M19,11H7.4l5.3-5.3c0.4-0.4,0.4-1,0-1.4s-1-0.4-1.4,0l-7,7c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.2-0.1,0.5,0,0.8c0.1,0.1,0.1,0.2,0.2,0.3l7,7c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3c0.4-0.4,0.4-1,0-1.4L7.4,13H19c0.6,0,1-0.4,1-1S19.6,11,19,11z"></path></svg><span class="text" data-v-38ede35f>副作用函数与响应式数据</span></a></div><div class="next" data-v-38ede35f><a class="link" href="/blog/vue3-analysis/reactivity/effectScope" data-v-38ede35f><span class="text" data-v-38ede35f>effectScope</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-38ede35f><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"index.md\":\"a951f7e9\",\"javascript_void.md\":\"3b53ba5e\",\"pinia_createpinia.md\":\"341e0cd9\",\"pinia_definestore.md\":\"829ce553\",\"pinia_maphelper.md\":\"bbcc2d13\",\"pinia_mapstate、mapactions.md\":\"f33f0ae3\",\"pinia_mapstores.md\":\"84cf5892\",\"pinia_mapwritablestate.md\":\"5569fe55\",\"pinia_preface.md\":\"ba3d9960\",\"pinia_storetorefs.md\":\"16d3efa3\",\"vue-router_addroute.md\":\"6a1adb23\",\"vue-router_back、forward.md\":\"c99961ba\",\"vue-router_creatememoryhistory.md\":\"1ce448be\",\"vue-router_createrouter.md\":\"38e7622e\",\"vue-router_createwebhashhistory.md\":\"c14c15b3\",\"vue-router_createwebhistory.md\":\"7e2e5802\",\"vue-router_getroutes.md\":\"e183d683\",\"vue-router_go.md\":\"240cbb65\",\"vue-router_hasroute.md\":\"ec36dc6d\",\"vue-router_isready.md\":\"8130aa67\",\"vue-router_preface.md\":\"fbf33b10\",\"vue-router_push.md\":\"870ddce3\",\"vue-router_removeroute.md\":\"4ed835ef\",\"vue-router_replace.md\":\"fbc7b4b3\",\"vue-router_resolve.md\":\"24744b22\",\"vue-router_router-install.md\":\"f66321ce\",\"vue-router_router-link.md\":\"04ebbba9\",\"vue-router_router-view.md\":\"7b6e5811\",\"vue-router_routermatcher.md\":\"1b4979de\",\"vue-router_uselink.md\":\"de237713\",\"vue-router_useroute、userouter.md\":\"f9471d3f\",\"vue-router_全局导航守卫.md\":\"4e848742\",\"vue-router_总结.md\":\"9adead8d\",\"vue-router_组件内导航守卫.md\":\"85e75b8c\",\"vue3-analysis_computed.md\":\"2c048047\",\"vue3-analysis_effect_依赖收集.md\":\"3c761b56\",\"vue3-analysis_effect_触发依赖.md\":\"ed3ee412\",\"vue3-analysis_reactive_reactive.md\":\"f9863c25\",\"vue3-analysis_reactive_readonly.md\":\"2c71ddf3\",\"vue3-analysis_reactive_shallowreactive.md\":\"9d574af1\",\"vue3-analysis_reactive_shallowreadonly.md\":\"376f4102\",\"vue3-analysis_reactive_toraw.md\":\"a213380d\",\"vue3-analysis_reactivity_effectscope.md\":\"ff1d978e\",\"vue3-analysis_reactivity_vue3的响应系统分析.md\":\"1fa66402\",\"vue3-analysis_reactivity_副作用函数与响应式数据.md\":\"57ad1cfa\",\"vue3-analysis_refs_customref.md\":\"89e2fd9a\",\"vue3-analysis_refs_ref.md\":\"57b24b45\",\"vue3-analysis_refs_shallowref.md\":\"216900e2\",\"vue3-analysis_structure.md\":\"12b589d3\",\"vue3-analysis_watch_watch.md\":\"ce3448fd\"}")</script>
    <script type="module" async src="/blog/assets/app.2233c548.js"></script>
    
  </body>
</html>