<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>routerMatcher | 我的博客</title>
    <meta name="description" content="A VitePress site">
    <link rel="stylesheet" href="/blog/assets/style.b948ed94.css">
    <link rel="modulepreload" href="/blog/assets/chunks/AlgoliaSearchBox.2e208df7.js">
    <link rel="modulepreload" href="/blog/assets/app.d2a36d2c.js">
    <link rel="modulepreload" href="/blog/assets/vue-router_routerMatcher.md.6c507e29.lean.js">
    
    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script>
  <script>window.addEventListener("load",function(o){let e=new MutationObserver(()=>{mediumZoom(document.querySelectorAll("img"),{background:"rgba(0, 0, 0, 0.5)"})}),t={childList:!0,subtree:!0};e.observe(document.getElementById("app"),t)});</script>
  <meta name="twitter:title" content="routerMatcher | 我的博客">
  <meta property="og:title" content="routerMatcher | 我的博客">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/blog/" aria-label="我的博客, back to home" data-v-675d8756 data-v-cc01ef16><!----> 我的博客</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><nav class="nav-links" data-v-675d8756 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>源码解析</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/blog/vue3-analysis/structure" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Vue3源码解析</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item active" href="/blog/vue-router/preface" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>vue-router源码解析</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/blog/pinia/preface" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>pinia源码解析</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/MAXLZ1/blog" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>Github <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav></div><!--[--><!--[--><div class="algolia-search-box" id="docsearch"></div><!--]--><!--]--></header><aside class="sidebar" data-v-83e92a68><nav class="nav-links nav" data-v-83e92a68 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>源码解析</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/blog/vue3-analysis/structure" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Vue3源码解析</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item active" href="/blog/vue-router/preface" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>vue-router源码解析</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/blog/pinia/preface" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>pinia源码解析</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/MAXLZ1/blog" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>Github <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/preface">前言</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/router-install">app.use(router)</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/createWebHistory">createWebHistory</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/createWebHashHistory">createWebHashHistory</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/createMemoryHistory">createMemoryHistory</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item active" href="/blog/vue-router/routerMatcher">routerMatcher</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/createRouter">createRouter</a><!----></li><li class="sidebar-link"><p class="sidebar-link-item">router方法</p><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/addRoute">addRoute</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/removeRoute">removeRoute</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/hasRoute">hasRoute</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/getRoutes">getRoutes</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/resolve">resolve</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/push">push</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/replace">replace</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/go">go</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/back、forward">back、forward</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/全局导航守卫">全局导航守卫</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/isReady">isReady</a><!----></li></ul></li><li class="sidebar-link"><p class="sidebar-link-item">Composition API</p><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/组件内导航守卫">组件内导航守卫</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/useRoute、useRouter">useRoute、useRouter</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/useLink">useLink</a><!----></li></ul></li><li class="sidebar-link"><p class="sidebar-link-item">路由组件</p><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/router-link">router-link</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/router-view">router-view</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-router/总结">总结</a><!----></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><h1 id="routermatcher" tabindex="-1">routerMatcher <a class="header-anchor" href="#routermatcher" aria-hidden="true">#</a></h1><div class="tip custom-block"><p class="custom-block-title">TIP</p><p><code>matcher</code>是<code>vue-router</code>中一个重要的概念，那么<code>matcher</code>是个什么东西呢？它是做什么的呢？本文将对<code>matcher</code>进行详细解读。</p><p>文件位置：<code>src/matcher/index.ts</code></p></div><p><code>vue-router</code>中通过一个<code>createRouterMatcher</code>来创建一个<code>routerMatcher</code>。<code>createRouterMatcher</code>接收两个参数：<code>routes</code>、<code>globalOptions</code>。其中<code>routes</code>为我们定义的路由表，也就是在<code>createRouter</code>时传入的<code>options.routes</code>，而<code>globalOptions</code>就是<code>createRouter</code>中的<code>options</code>。</p><p>首先我们看<code>createRouterMatcher</code>函数的返回值，<code>createRouterMatcher</code>返回一个对象，该对象有<code>addRoute</code>、<code>resolve</code>、<code>removeRoute</code>、<code>getRoute</code>、<code>getRecordMatcher</code>几个属性，而这几个属性从其命名上可以看出应该是一些路由操作方法。现在我们大致知道了<code>routerMatcher</code>是个什么东西。<code>routerMatcher</code>包含了对路由的一些操作方法，其中包含添加路由（<code>addRoute</code>）、路由地址标准化（<code>resolve</code>）、删除路由（<code>removeRoute</code>）、获取路由完整列表（<code>getRoutes</code>）、获取某个路由的<code>matcher</code>（<code>getRecordMatcher</code>）</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRouterMatcher</span><span class="token punctuation">(</span>
  routes<span class="token operator">:</span> RouteRecordRaw<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  globalOptions<span class="token operator">:</span> PathParserOptions
<span class="token punctuation">)</span><span class="token operator">:</span> RouterMatcher <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> addRoute<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> removeRoute<span class="token punctuation">,</span> getRoutes<span class="token punctuation">,</span> getRecordMatcher <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>接下来我们看下<code>createRouterMatcher</code>的中间过程：</p><p>先声明一个数组和一个Map，用来存储<code>RouteRecordMatcher</code>路由记录匹配器，然后<code>mergeOptions</code></p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">const</span> matchers<span class="token operator">:</span> RouteRecordMatcher<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> matcherMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span>RouteRecordName<span class="token punctuation">,</span> RouteRecordMatcher<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
globalOptions <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span> strict<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> sensitive<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> PathParserOptions<span class="token punctuation">,</span>
  globalOptions
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p><code>RouteRecordMatcher</code>类型的定义：</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">RouteRecordMatcher</span> <span class="token keyword">extends</span> <span class="token class-name">PathParser</span> <span class="token punctuation">{</span>
  record<span class="token operator">:</span> RouteRecord
  parent<span class="token operator">:</span> RouteRecordMatcher <span class="token operator">|</span> <span class="token keyword">undefined</span>
  children<span class="token operator">:</span> RouteRecordMatcher<span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// aliases that must be removed when removing this record</span>
  alias<span class="token operator">:</span> RouteRecordMatcher<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></div><p>这里<code>mergeOptions</code>的实现如下。它的作用是如果<code>partialOptions</code>中有<code>defaults</code>中的<code>key</code>值，那么就使用<code>partialOptions</code>中对应<code>key</code>的值替换<code>defaults</code>中的值</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">mergeOptions</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>defaults<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> partialOptions<span class="token operator">:</span> Partial<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token constant">T</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> defaults<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> key <span class="token keyword">in</span> partialOptions <span class="token operator">?</span> partialOptions<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">!</span> <span class="token operator">:</span> defaults<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> options
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>之后会声明<code>getRecordMatcher</code>、<code>removeRoute</code>、<code>addRoute</code>、<code>insertMatcher</code>、<code>getRoute</code>、<code>resolve</code>几个函数，先暂时不关心这几个函数的具体细节。</p><p>声明几个函数之后，会对路由进行初始化：遍历路由表，调用<code>addRoute</code>方法。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token comment">// add initial routes</span>
routes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>route <span class="token operator">=&gt;</span> <span class="token function">addRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>最后返回结果。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">return</span> <span class="token punctuation">{</span> addRoute<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> removeRoute<span class="token punctuation">,</span> getRoutes<span class="token punctuation">,</span> getRecordMatcher <span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>接下来重点看下在<code>createRouterMatcher</code>中定义的几个函数：</p><h3 id="addroute" tabindex="-1"><code>addRoute</code> <a class="header-anchor" href="#addroute" aria-hidden="true">#</a></h3><p><code>addRoute</code>函数接收三个参数：<code>record</code>（新增的路由）、<code>parent</code>（父<code>matcher</code>）、<code>originalRecord</code>（原始<code>matcher</code>）。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">function</span> <span class="token function">addRoute</span><span class="token punctuation">(</span>
  record<span class="token operator">:</span> RouteRecordRaw<span class="token punctuation">,</span>
  parent<span class="token operator">?</span><span class="token operator">:</span> RouteRecordMatcher<span class="token punctuation">,</span>
  originalRecord<span class="token operator">?</span><span class="token operator">:</span> RouteRecordMatcher
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// used later on to remove by name</span>
  <span class="token keyword">const</span> isRootAdd <span class="token operator">=</span> <span class="token operator">!</span>originalRecord
  <span class="token comment">// 标准化化路由记录</span>
  <span class="token keyword">const</span> mainNormalizedRecord <span class="token operator">=</span> <span class="token function">normalizeRouteRecord</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span>
  <span class="token comment">// aliasOf表示此记录是否是另一个记录的别名</span>
  mainNormalizedRecord<span class="token punctuation">.</span>aliasOf <span class="token operator">=</span> originalRecord <span class="token operator">&amp;&amp;</span> originalRecord<span class="token punctuation">.</span>record
  <span class="token keyword">const</span> options<span class="token operator">:</span> PathParserOptions <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>globalOptions<span class="token punctuation">,</span> record<span class="token punctuation">)</span>
  <span class="token comment">// 声明一个记录的数组用来处理别名</span>
  <span class="token keyword">const</span> normalizedRecords<span class="token operator">:</span> <span class="token keyword">typeof</span> mainNormalizedRecord<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    mainNormalizedRecord<span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
  <span class="token comment">// 如果record设置了别名</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&#39;alias&#39;</span> <span class="token keyword">in</span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 别名数组</span>
    <span class="token keyword">const</span> aliases <span class="token operator">=</span>
      <span class="token keyword">typeof</span> record<span class="token punctuation">.</span>alias <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">?</span> <span class="token punctuation">[</span>record<span class="token punctuation">.</span>alias<span class="token punctuation">]</span> <span class="token operator">:</span> record<span class="token punctuation">.</span>alias<span class="token operator">!</span>
    <span class="token comment">// 遍历别名数组，并根据别名创建记录存储到normalizedRecords中</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> alias <span class="token keyword">of</span> aliases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      normalizedRecords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
        <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> mainNormalizedRecord<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          components<span class="token operator">:</span> originalRecord
            <span class="token operator">?</span> originalRecord<span class="token punctuation">.</span>record<span class="token punctuation">.</span>components
            <span class="token operator">:</span> mainNormalizedRecord<span class="token punctuation">.</span>components<span class="token punctuation">,</span>
          path<span class="token operator">:</span> alias<span class="token punctuation">,</span>
          <span class="token comment">// 如果有原始记录，aliasOf为原始记录，如果没有原始记录就是它自己</span>
          aliasOf<span class="token operator">:</span> originalRecord
            <span class="token operator">?</span> originalRecord<span class="token punctuation">.</span>record
            <span class="token operator">:</span> mainNormalizedRecord<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">typeof</span> mainNormalizedRecord
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> matcher<span class="token operator">:</span> RouteRecordMatcher
  <span class="token keyword">let</span> originalMatcher<span class="token operator">:</span> RouteRecordMatcher <span class="token operator">|</span> <span class="token keyword">undefined</span>

  <span class="token comment">// 遍历normalizedRecords</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> normalizedRecord <span class="token keyword">of</span> normalizedRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token comment">// 处理normalizedRecord.path为完整的path</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> normalizedRecord
    <span class="token comment">// 如果path不是以/开头，那么说明它不是根路由，需要拼接为完整的path</span>
    <span class="token comment">// { path: &#39;/a&#39;, children: [ { path: &#39;b&#39; } ] } -&gt; { path: &#39;/a&#39;, children: [ { path: &#39;/a/b&#39; } ] }</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> parentPath <span class="token operator">=</span> parent<span class="token punctuation">.</span>record<span class="token punctuation">.</span>path
      <span class="token keyword">const</span> connectingSlash <span class="token operator">=</span>
        parentPath<span class="token punctuation">[</span>parentPath<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;/&#39;</span> <span class="token operator">?</span> <span class="token string">&#39;&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;/&#39;</span>
      normalizedRecord<span class="token punctuation">.</span>path <span class="token operator">=</span>
        parent<span class="token punctuation">.</span>record<span class="token punctuation">.</span>path <span class="token operator">+</span> <span class="token punctuation">(</span>path <span class="token operator">&amp;&amp;</span> connectingSlash <span class="token operator">+</span> path<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 提示*应使用正则表示式形式</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> normalizedRecord<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">&#39;*&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token string">&#39;Catch all routes (&quot;*&quot;) must now be defined using a param with a custom regexp.\n&#39;</span> <span class="token operator">+</span>
          <span class="token string">&#39;See more at https://next.router.vuejs.org/guide/migration/#removed-star-or-catch-all-routes.&#39;</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 创建一个路由记录匹配器</span>
    matcher <span class="token operator">=</span> <span class="token function">createRouteRecordMatcher</span><span class="token punctuation">(</span>normalizedRecord<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> options<span class="token punctuation">)</span>

    <span class="token comment">// 检查是否有丢失的参数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> parent <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span>
      <span class="token function">checkMissingParamsInAbsolutePath</span><span class="token punctuation">(</span>matcher<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>

    <span class="token comment">// 如果有originalRecord，将matcher放入原始记录的alias中，以便后续能够删除</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>originalRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      originalRecord<span class="token punctuation">.</span>alias<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span>
      <span class="token comment">// 检查originalRecord与matcher中动态参数是否相同</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">checkSameParams</span><span class="token punctuation">(</span>originalRecord<span class="token punctuation">,</span> matcher<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 没有originalRecord</span>
      <span class="token comment">// 因为原始记录索引为0，所以originalMatcher为有原始记录所产生的matcher</span>
      originalMatcher <span class="token operator">=</span> originalMatcher <span class="token operator">||</span> matcher
      <span class="token comment">// 如果matcher不是原始记录产生的matcher，说明此时matcher是由别名记录产生的，此时将matcher放入originalMatcher.alias中</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>originalMatcher <span class="token operator">!==</span> matcher<span class="token punctuation">)</span> originalMatcher<span class="token punctuation">.</span>alias<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span>
      <span class="token comment">// 如果命名并且仅用于顶部记录，则删除路由（避免嵌套调用）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isRootAdd <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>name <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isAliasRecord</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">removeRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 遍历children，递归addRoute</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&#39;children&#39;</span> <span class="token keyword">in</span> mainNormalizedRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> children <span class="token operator">=</span> mainNormalizedRecord<span class="token punctuation">.</span>children
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">addRoute</span><span class="token punctuation">(</span>
          children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
          matcher<span class="token punctuation">,</span>
          originalRecord <span class="token operator">&amp;&amp;</span> originalRecord<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    originalRecord <span class="token operator">=</span> originalRecord <span class="token operator">||</span> matcher
    <span class="token comment">// 添加matcher</span>
    <span class="token function">insertMatcher</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 返回一个删除路由的方法</span>
  <span class="token keyword">return</span> originalMatcher
    <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">removeRoute</span><span class="token punctuation">(</span>originalMatcher<span class="token operator">!</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token operator">:</span> noop
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br></div></div><p>上述代码中<code>createRouteRecordMatcher</code>是什么呢？在看<code>createRouteRecordMatcher</code>之前，我们先看这么两个函数：<code>tokenizePath</code>、<code>tokensToParser</code>。<code>tokenizePath</code>将<code>path</code>转为一个<code>token</code>数组。<code>tokensToParser</code>会根据<code>token</code>数组创建一个路径解析器。</p><p>那么什么是<code>token</code>呢？我们看下<code>vue-router</code>中<code>token</code>的类型定义：</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">interface</span> <span class="token class-name">TokenStatic</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> TokenType<span class="token punctuation">.</span>Static
  value<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">TokenParam</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> TokenType<span class="token punctuation">.</span>Param
  regexp<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
  value<span class="token operator">:</span> <span class="token builtin">string</span>
  optional<span class="token operator">:</span> <span class="token builtin">boolean</span>
  repeatable<span class="token operator">:</span> <span class="token builtin">boolean</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">TokenGroup</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> TokenType<span class="token punctuation">.</span>Group
  value<span class="token operator">:</span> Exclude<span class="token operator">&lt;</span>Token<span class="token punctuation">,</span> TokenGroup<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">Token</span> <span class="token operator">=</span> TokenStatic <span class="token operator">|</span> TokenParam <span class="token operator">|</span> TokenGroup
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><code>token</code>分为三种：</p><ul><li><code>TokenStatic</code>：一种静态的<code>token</code>，说明<code>token</code>不可变</li><li><code>TokenParam</code>：参数<code>token</code>，说明<code>token</code>是个参数</li><li><code>TokenGroup</code>：分组的<code>token</code></li></ul><p>这里我们举几个例子：</p><ol><li><code>/one/two/three</code>对应的<code>token</code>数组：</li></ol><div class="language-ts line-numbers-mode"><pre><code><span class="token punctuation">[</span>
  <span class="token punctuation">[</span><span class="token punctuation">{</span> type<span class="token operator">:</span> TokenType<span class="token punctuation">.</span>Static<span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">&#39;one&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token punctuation">{</span> type<span class="token operator">:</span> TokenType<span class="token punctuation">.</span>Static<span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">&#39;two&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token punctuation">{</span> type<span class="token operator">:</span> TokenType<span class="token punctuation">.</span>Static<span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">&#39;three&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="2"><li><code>/user/:id</code>对应的<code>token</code>数组是:</li></ol><div class="language-ts line-numbers-mode"><pre><code><span class="token punctuation">[</span>
  <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> TokenType<span class="token punctuation">.</span>Static<span class="token punctuation">,</span>
      value<span class="token operator">:</span> <span class="token string">&#39;user&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> TokenType<span class="token punctuation">.</span>Param<span class="token punctuation">,</span>
      value<span class="token operator">:</span> <span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span>
      regexp<span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
      repeatable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      optional<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ol start="3"><li><code>/:id(\\d+)new</code>对应的<code>token</code>数组：</li></ol><div class="language-ts line-numbers-mode"><pre><code><span class="token punctuation">[</span>
  <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> TokenType<span class="token punctuation">.</span>Param<span class="token punctuation">,</span>
      value<span class="token operator">:</span> <span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span>
      regexp<span class="token operator">:</span> <span class="token string">&#39;\\d+&#39;</span><span class="token punctuation">,</span>
      repeatable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      optional<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> TokenType<span class="token punctuation">.</span>Static<span class="token punctuation">,</span>
      value<span class="token operator">:</span> <span class="token string">&#39;new&#39;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>从上面几个例子可以看出，<code>token</code>数组详细描述了<code>path</code>的每一级路由的组成。例如第3个例子<code>/:id(\\d+)new</code>，通过<code>token</code>数组我们能够知道他是一个一级路由（<code>token.lenght = 1</code>），并且它的这级路由是由两部分组成，其中第一部分是参数部分，第二部分是静态的，并且在参数部分还说明了参数的正则及是否重复、是否可选的配置。</p><p>知道了<code>token</code>是什么，接下来我们看下<code>tokenizePath</code>是如何将<code>path</code>转为<code>token</code>的：</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> TokenType <span class="token punctuation">{</span>
  Static<span class="token punctuation">,</span>
  Param<span class="token punctuation">,</span>
  Group<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token constant">ROOT_TOKEN</span><span class="token operator">:</span> Token <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> TokenType<span class="token punctuation">.</span>Static<span class="token punctuation">,</span>
  value<span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">tokenizePath</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>Token<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>path<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path <span class="token operator">===</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token constant">ROOT_TOKEN</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
  <span class="token comment">// 如果path不是以/开头，抛出错误</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>path<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
      __DEV__
        <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Route paths should start with a &quot;/&quot;: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; should be &quot;/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
        <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid path &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">function</span> <span class="token function">crash</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ERR (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)/&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buffer<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// token所处状态</span>
  <span class="token keyword">let</span> state<span class="token operator">:</span> TokenizerState <span class="token operator">=</span> TokenizerState<span class="token punctuation">.</span>Static
  <span class="token comment">// 前一个状态</span>
  <span class="token keyword">let</span> previousState<span class="token operator">:</span> TokenizerState <span class="token operator">=</span> state
  <span class="token keyword">const</span> tokens<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>Token<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">//  声明一个片段，该片段最终会被存入tokens中</span>
  <span class="token keyword">let</span> segment<span class="token operator">!</span><span class="token operator">:</span> Token<span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token comment">// 添加segment至tokens中，同时segment重新变为空数组</span>
  <span class="token keyword">function</span> <span class="token function">finalizeSegment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>segment<span class="token punctuation">)</span> tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>segment<span class="token punctuation">)</span>
    segment <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">let</span> char<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token keyword">let</span> buffer<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
  <span class="token comment">// custom regexp for a param</span>
  <span class="token keyword">let</span> customRe<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>

  <span class="token comment">// 消费buffer，即生成token添加到segment中</span>
  <span class="token keyword">function</span> <span class="token function">consumeBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buffer<span class="token punctuation">)</span> <span class="token keyword">return</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">===</span> TokenizerState<span class="token punctuation">.</span>Static<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      segment<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> TokenType<span class="token punctuation">.</span>Static<span class="token punctuation">,</span>
        value<span class="token operator">:</span> buffer<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
      state <span class="token operator">===</span> TokenizerState<span class="token punctuation">.</span>Param <span class="token operator">||</span>
      state <span class="token operator">===</span> TokenizerState<span class="token punctuation">.</span>ParamRegExp <span class="token operator">||</span>
      state <span class="token operator">===</span> TokenizerState<span class="token punctuation">.</span>ParamRegExpEnd
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>segment<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">&#39;*&#39;</span> <span class="token operator">||</span> char <span class="token operator">===</span> <span class="token string">&#39;+&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">crash</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">A repeatable param (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buffer<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">) must be alone in its segment. eg: &#39;/:ids+.</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span>
      segment<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> TokenType<span class="token punctuation">.</span>Param<span class="token punctuation">,</span>
        value<span class="token operator">:</span> buffer<span class="token punctuation">,</span>
        regexp<span class="token operator">:</span> customRe<span class="token punctuation">,</span>
        repeatable<span class="token operator">:</span> char <span class="token operator">===</span> <span class="token string">&#39;*&#39;</span> <span class="token operator">||</span> char <span class="token operator">===</span> <span class="token string">&#39;+&#39;</span><span class="token punctuation">,</span>
        optional<span class="token operator">:</span> char <span class="token operator">===</span> <span class="token string">&#39;*&#39;</span> <span class="token operator">||</span> char <span class="token operator">===</span> <span class="token string">&#39;?&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">crash</span><span class="token punctuation">(</span><span class="token string">&#39;Invalid state to consume buffer&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 消费完后置空</span>
    buffer <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">addCharToBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    buffer <span class="token operator">+=</span> char
  <span class="token punctuation">}</span>

  <span class="token comment">// 遍历path</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> path<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    char <span class="token operator">=</span> path<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span>

    <span class="token comment">// path=&#39;/\\:&#39;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">&#39;\\&#39;</span> <span class="token operator">&amp;&amp;</span> state <span class="token operator">!==</span> TokenizerState<span class="token punctuation">.</span>ParamRegExp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      previousState <span class="token operator">=</span> state
      state <span class="token operator">=</span> TokenizerState<span class="token punctuation">.</span>EscapeNext
      <span class="token keyword">continue</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> TokenizerState<span class="token punctuation">.</span>Static<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">consumeBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// char === /时说明已经遍历完一层路由，这时需要将segment添加到tokens中</span>
          <span class="token function">finalizeSegment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">&#39;:&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// char为:时，因为此时状态是TokenizerState.Static，所以:后是参数，此时要把state变为TokenizerState.Param</span>
          <span class="token function">consumeBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          state <span class="token operator">=</span> TokenizerState<span class="token punctuation">.</span>Param
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 其他情况拼接buffer</span>
          <span class="token function">addCharToBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span>

      <span class="token keyword">case</span> TokenizerState<span class="token punctuation">.</span>EscapeNext<span class="token operator">:</span>
        <span class="token function">addCharToBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        state <span class="token operator">=</span> previousState
        <span class="token keyword">break</span>

      <span class="token keyword">case</span> TokenizerState<span class="token punctuation">.</span>Param<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">&#39;(&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 碰到(，因为此时state为TokenizerState.Param，说明后面是正则表达式，所以修改state为TokenizerState.ParamRegExp</span>
          state <span class="token operator">=</span> TokenizerState<span class="token punctuation">.</span>ParamRegExp
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">VALID_PARAM_RE</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">addCharToBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 例如/:id/one，当遍历到第二个/时，消费buffer，state变为Static，并让i回退，回退后进入Static</span>
          <span class="token function">consumeBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          state <span class="token operator">=</span> TokenizerState<span class="token punctuation">.</span>Static
          <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">!==</span> <span class="token string">&#39;*&#39;</span> <span class="token operator">&amp;&amp;</span> char <span class="token operator">!==</span> <span class="token string">&#39;?&#39;</span> <span class="token operator">&amp;&amp;</span> char <span class="token operator">!==</span> <span class="token string">&#39;+&#39;</span><span class="token punctuation">)</span> i<span class="token operator">--</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span>

      <span class="token keyword">case</span> TokenizerState<span class="token punctuation">.</span>ParamRegExp<span class="token operator">:</span> 
        <span class="token comment">// it already works by escaping the closing )</span>
        <span class="token comment">// TODO: is it worth handling nested regexp? like :p(?:prefix_([^/]+)_suffix)</span>
        <span class="token comment">// https://paths.esm.dev/?p=AAMeJbiAwQEcDKbAoAAkP60PG2R6QAvgNaA6AFACM2ABuQBB#</span>
        <span class="token comment">// is this really something people need since you can also write</span>
        <span class="token comment">// /prefix_:p()_suffix</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">&#39;)&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果是\\)的情况,customRe = customRe去掉\\ + char</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>customRe<span class="token punctuation">[</span>customRe<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&#39;\\&#39;</span><span class="token punctuation">)</span>
            customRe <span class="token operator">=</span> customRe<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> char
          <span class="token keyword">else</span> state <span class="token operator">=</span> TokenizerState<span class="token punctuation">.</span>ParamRegExpEnd <span class="token comment">// 如果不是\\)说明正则表达式已经遍历完</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          customRe <span class="token operator">+=</span> char
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span>

      <span class="token keyword">case</span> TokenizerState<span class="token punctuation">.</span>ParamRegExpEnd<span class="token operator">:</span> <span class="token comment">// 正则表达式已经遍历完</span>
        <span class="token comment">// 消费buffer</span>
        <span class="token function">consumeBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 重置state为Static</span>
        state <span class="token operator">=</span> TokenizerState<span class="token punctuation">.</span>Static
        <span class="token comment">// 例如/:id(\\d+)new，当遍历到n时，使i回退，下一次进入Static分支中处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">!==</span> <span class="token string">&#39;*&#39;</span> <span class="token operator">&amp;&amp;</span> char <span class="token operator">!==</span> <span class="token string">&#39;?&#39;</span> <span class="token operator">&amp;&amp;</span> char <span class="token operator">!==</span> <span class="token string">&#39;+&#39;</span><span class="token punctuation">)</span> i<span class="token operator">--</span>
        customRe <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
        <span class="token keyword">break</span>

      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token function">crash</span><span class="token punctuation">(</span><span class="token string">&#39;Unknown state&#39;</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果遍历结束后，state还是ParamRegExp状态，说明正则是没有结束的，可能漏了)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">===</span> TokenizerState<span class="token punctuation">.</span>ParamRegExp<span class="token punctuation">)</span>
    <span class="token function">crash</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unfinished custom RegExp for param &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buffer<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

  <span class="token comment">// 遍历完path，进行最后一次消费buffer</span>
  <span class="token function">consumeBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 将segment放入tokens</span>
  <span class="token function">finalizeSegment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// 最后返回tokens</span>
  <span class="token keyword">return</span> tokens
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br></div></div><p>还是以第3个为例<code>/:id(\\d+)new</code>、，我们看一下<code>tokenizePath</code>的过程：</p><ol><li>遍历前的状态：<code>state=TokenizerState.Static; previousState=TokenizerState.Static; tokens=[]; segment; buffer=&#39;&#39;; i=0; char=&#39;&#39;; customRe=&#39;&#39;;</code></li><li>当<code>i=0</code>时，进入<code>TokenizerState.Static</code>分支，此时<code>char=&#39;/&#39;; buffer=&#39;&#39;;</code>，不会执行<code>consumeBuffer</code>，执行<code>finalizeSegment</code>，该轮结束后发生变化的是<code>segment=[]; i=1; char=&#39;/&#39;;</code></li><li>当<code>i=1</code>时，进入<code>TokenizerState.Static</code>分支，此时<code>char=&#39;:&#39;; buffer=&#39;&#39;;</code>，执行<code>consumeBuffer</code>，因为<code>buffer=&#39;&#39;</code>，所以<code>consumeBuffer</code>中什么都没做，最后<code>state=TokenizerState.Param</code>，该轮结束后发生变化的是<code>state=TokenizerState.Param; i=2; char=&#39;:&#39;;</code></li><li>当<code>i=2</code>时，进入<code>TokenizerState.Param</code>分支，此时<code>char=&#39;i&#39;; buffer=&#39;&#39;;</code>，执行<code>addCharToBuffer</code>，该轮结束后发生变化的是<code>buffer=&#39;i&#39;; i=3; char=&#39;i&#39;;</code></li><li>当<code>i=3</code>时，过程同4，该轮结束后发生变化的是<code>buffer=&#39;id&#39;; i=4; char=&#39;d&#39;;</code></li><li>当<code>i=4</code>时，进入<code>TokenizerState.Param</code>分支，此时<code>char=&#39;(&#39;; buffer=&#39;id&#39;;</code>，此时会将<code>state</code>变为<code>TokenizerState.ParamRegExp</code>，说明<code>(</code>后面是正则，该轮结束后发生变化的是<code>state=TokenizerState.ParamRegExp; i=5; char=&#39;(&#39;;</code></li><li>当<code>i=5</code>时，进入<code>TokenizerState.ParamRegExp</code>分支，此时<code>char=&#39;\\&#39;; buffer=&#39;id&#39;;</code>，执行<code>customRe+=char</code>，该轮结束后发生变化的是<code>i=6; char=&#39;\\&#39;; customRe=&#39;\\&#39;</code></li><li>当<code>i=6</code>、<code>i=7</code>时，过程同5，最终发生变化的是<code>i=8; char=&#39;+&#39;; customRe=&#39;\\d+&#39;</code></li><li>当<code>i=8</code>时，进入<code>TokenizerState.ParamRegExp</code>分支，此时<code>char=&#39;)&#39;; buffer=&#39;id&#39;; customRe=&#39;\\d+&#39;</code>，<code>state</code>变为<code>TokenizerState.ParamRegExpEnd</code>，代表正则结束，该轮结束后发生变化的是<code>state=TokenizerState.ParamRegExpEnd; i=9; char=&#39;)&#39;;</code></li><li>当<code>i=9</code>时，进入<code>TokenizerState.ParamRegExpEnd</code>分支，此时<code>char=&#39;n&#39;; buffer=&#39;id&#39;; customRe=&#39;\\d+&#39;</code>，执行<code>consumeBuffer</code>，在<code>consumeBuffer</code>中会向<code>segment</code>添加一条<code>token</code>并将<code>buffer</code>置为空字符串，该<code>token</code>是<code>{type: TokenType.Param, value: &#39;id&#39;, regexp: &#39;\\d+&#39;, repeatable: false, optional: false}</code>，执行完<code>consumeBuffer</code>后，<code>state</code>重置为<code>Static</code>，<code>customRe</code>重置为空字符串，<code>i</code>回退1，该轮结束后发生变化的是<code>segment=[{...}]; state=TokenizerState.Static; buffer=&#39;&#39;; customRe=&#39;&#39;; char=&#39;n&#39;;</code>，注意此时<code>i=9</code></li><li>上一轮结束后<code>i=9</code>，进入<code>TokenizerState.Static</code>分支，此时此时<code>char=&#39;n&#39;; buffer=&#39;&#39;;</code>，执行<code>addCharToBuffer</code>方法，该轮结束后发生变化的是<code>buffer=&#39;n&#39;; i=10; char=&#39;n&#39;</code></li><li>当<code>i=10</code>、<code>i=11</code>时，过程同11，结束后发生变化的是<code>buffer=&#39;new&#39;; i=12; char=&#39;w&#39;</code></li><li>当<code>i=12</code>，结束遍历，执行<code>consumeBuffer</code>，向<code>segment</code>添加<code>{type: TokenType.Static, value: &#39;new&#39;}</code>一条记录并将<code>buffer</code>置为空字符串。然后执行<code>finalizeSegment</code>，将<code>segment</code>添加到<code>tokens</code>中，并将<code>segment</code>置为空数组。最后返回的<code>tokens</code>如下：</li></ol><div class="language-ts line-numbers-mode"><pre><code><span class="token punctuation">[</span>
  <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> TokenType<span class="token punctuation">.</span>Param<span class="token punctuation">,</span>
      value<span class="token operator">:</span> <span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span>
      regexp<span class="token operator">:</span> <span class="token string">&#39;\\d+&#39;</span><span class="token punctuation">,</span>
      repeatable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      optional<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> TokenType<span class="token punctuation">.</span>Static<span class="token punctuation">,</span>
      value<span class="token operator">:</span> <span class="token string">&#39;new&#39;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>现在我们清楚了<code>tokens</code>的生成，接下里我们看下<code>tokensToParser</code>。</p><p><code>tokensToParser</code>函数接收一个<code>token</code>数组和一个可选的<code>extraOptions</code>，在函数中会构造出<code>path</code>对应的正则表达式、动态参数列表<code>keys</code>、<code>token</code>对应的分数（相当于权重，该分数在后续<code>path</code>的比较中会用到）、一个可以从<code>path</code>中提取动态参数的函数（<code>parse</code>）、一个可以根据传入的动态参数生成<code>path</code>的函数（<code>stringify</code>），最后将其组成一个对象返回。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">const</span> <span class="token constant">BASE_PATH_PARSER_OPTIONS</span><span class="token operator">:</span> Required<span class="token operator">&lt;</span>_PathParserOptions<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  sensitive<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  strict<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  start<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  end<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token constant">REGEX_CHARS_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[.+*?^${}()[\]/\\]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">tokensToParser</span><span class="token punctuation">(</span>
  segments<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>Token<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  extraOptions<span class="token operator">?</span><span class="token operator">:</span> _PathParserOptions
<span class="token punctuation">)</span><span class="token operator">:</span> PathParser <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">BASE_PATH_PARSER_OPTIONS</span><span class="token punctuation">,</span> extraOptions<span class="token punctuation">)</span>

  <span class="token comment">// the amount of scores is the same as the length of segments except for the root segment &quot;/&quot;</span>
  <span class="token keyword">const</span> score<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// 正则的字符串形式</span>
  <span class="token keyword">let</span> pattern <span class="token operator">=</span> options<span class="token punctuation">.</span>start <span class="token operator">?</span> <span class="token string">&#39;^&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;&#39;</span>
  <span class="token comment">// 保存路由中的动态参数</span>
  <span class="token keyword">const</span> keys<span class="token operator">:</span> PathParserParamKey<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> segment <span class="token keyword">of</span> segments<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 用一个数组保存token的分数</span>
    <span class="token keyword">const</span> segmentScores<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> segment<span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span>PathScore<span class="token punctuation">.</span>Root<span class="token punctuation">]</span>

    <span class="token comment">// options.strict代表是否禁止尾部/，如果禁止了pattern追加/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>strict <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>segment<span class="token punctuation">.</span>length<span class="token punctuation">)</span> pattern <span class="token operator">+=</span> <span class="token string">&#39;/&#39;</span>
    <span class="token comment">// 开始遍历每个token</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> tokenIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> tokenIndex <span class="token operator">&lt;</span> segment<span class="token punctuation">.</span>length<span class="token punctuation">;</span> tokenIndex<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> token <span class="token operator">=</span> segment<span class="token punctuation">[</span>tokenIndex<span class="token punctuation">]</span>
      <span class="token comment">// 当前子片段（单个token）的分数</span>
      <span class="token keyword">let</span> subSegmentScore<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span>
        PathScore<span class="token punctuation">.</span>Segment <span class="token operator">+</span>
        <span class="token punctuation">(</span>options<span class="token punctuation">.</span>sensitive <span class="token operator">?</span> PathScore<span class="token punctuation">.</span>BonusCaseSensitive <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>type <span class="token operator">===</span> TokenType<span class="token punctuation">.</span>Static<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 在开始一个新的片段前pattern需要添加/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tokenIndex<span class="token punctuation">)</span> pattern <span class="token operator">+=</span> <span class="token string">&#39;/&#39;</span>
        <span class="token comment">// 将token.value追加到pattern后，追加前token.value中的.、+、*、?、^、$等字符前面加上\\</span>
        <span class="token comment">// 关于replace，参考MDN：https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String/replace</span>
        pattern <span class="token operator">+=</span> token<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">REGEX_CHARS_RE</span><span class="token punctuation">,</span> <span class="token string">&#39;\\$&amp;&#39;</span><span class="token punctuation">)</span>
        subSegmentScore <span class="token operator">+=</span> PathScore<span class="token punctuation">.</span>Static
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>type <span class="token operator">===</span> TokenType<span class="token punctuation">.</span>Param<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> repeatable<span class="token punctuation">,</span> optional<span class="token punctuation">,</span> regexp <span class="token punctuation">}</span> <span class="token operator">=</span> token
        keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          name<span class="token operator">:</span> value<span class="token punctuation">,</span>
          repeatable<span class="token punctuation">,</span>
          optional<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> re <span class="token operator">=</span> regexp <span class="token operator">?</span> regexp <span class="token operator">:</span> <span class="token constant">BASE_PARAM_PATTERN</span>
        <span class="token comment">// 用户自定义的正则需要验证正则的正确性</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>re <span class="token operator">!==</span> <span class="token constant">BASE_PARAM_PATTERN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          subSegmentScore <span class="token operator">+=</span> PathScore<span class="token punctuation">.</span>BonusCustomRegExp
          <span class="token comment">// 使用前确保正则时正确的</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>re<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid custom RegExp for param &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>re<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">): </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
                <span class="token punctuation">(</span>err <span class="token keyword">as</span> Error<span class="token punctuation">)</span><span class="token punctuation">.</span>message
            <span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// /:chapters*</span>
        <span class="token comment">// when we repeat we must take care of the repeating leading slash</span>
        <span class="token keyword">let</span> subPattern <span class="token operator">=</span> repeatable <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">((?:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>re<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)(?:/(?:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>re<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">))*)</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>re<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>

        <span class="token comment">// prepend the slash if we are starting a new segment</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tokenIndex<span class="token punctuation">)</span>
          subPattern <span class="token operator">=</span>
            <span class="token comment">// avoid an optional / if there are more segments e.g. /:p?-static</span>
            <span class="token comment">// or /:p?-:p2</span>
            optional <span class="token operator">&amp;&amp;</span> segment<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">2</span>
              <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(?:/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>subPattern<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
              <span class="token operator">:</span> <span class="token string">&#39;/&#39;</span> <span class="token operator">+</span> subPattern
        <span class="token keyword">if</span> <span class="token punctuation">(</span>optional<span class="token punctuation">)</span> subPattern <span class="token operator">+=</span> <span class="token string">&#39;?&#39;</span>

        pattern <span class="token operator">+=</span> subPattern

        subSegmentScore <span class="token operator">+=</span> PathScore<span class="token punctuation">.</span>Dynamic
        <span class="token keyword">if</span> <span class="token punctuation">(</span>optional<span class="token punctuation">)</span> subSegmentScore <span class="token operator">+=</span> PathScore<span class="token punctuation">.</span>BonusOptional
        <span class="token keyword">if</span> <span class="token punctuation">(</span>repeatable<span class="token punctuation">)</span> subSegmentScore <span class="token operator">+=</span> PathScore<span class="token punctuation">.</span>BonusRepeatable
        <span class="token keyword">if</span> <span class="token punctuation">(</span>re <span class="token operator">===</span> <span class="token string">&#39;.*&#39;</span><span class="token punctuation">)</span> subSegmentScore <span class="token operator">+=</span> PathScore<span class="token punctuation">.</span>BonusWildcard
      <span class="token punctuation">}</span>

      segmentScores<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>subSegmentScore<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    score<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>segmentScores<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// only apply the strict bonus to the last score</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>strict <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> i <span class="token operator">=</span> score<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
    score<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>score<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> PathScore<span class="token punctuation">.</span>BonusStrict
  <span class="token punctuation">}</span>

  <span class="token comment">// TODO: dev only warn double trailing slash</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>strict<span class="token punctuation">)</span> pattern <span class="token operator">+=</span> <span class="token string">&#39;/?&#39;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>end<span class="token punctuation">)</span> pattern <span class="token operator">+=</span> <span class="token string">&#39;$&#39;</span>
  <span class="token comment">// allow paths like /dynamic to only match dynamic or dynamic/... but not dynamic_something_else</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>strict<span class="token punctuation">)</span> pattern <span class="token operator">+=</span> <span class="token string">&#39;(?:/|$)&#39;</span>

  <span class="token comment">// 根据组装好的pattern创建正则表达式，options.sensitive决定是否区分大小写</span>
  <span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> options<span class="token punctuation">.</span>sensitive <span class="token operator">?</span> <span class="token string">&#39;&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;i&#39;</span><span class="token punctuation">)</span>

  <span class="token comment">// 根据path获取动态参数对象</span>
  <span class="token keyword">function</span> <span class="token function">parse</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> PathParams <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> match <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>re<span class="token punctuation">)</span>
    <span class="token keyword">const</span> params<span class="token operator">:</span> PathParams <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>match<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> match<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> value<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> match<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">&#39;&#39;</span>
      <span class="token keyword">const</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
      params<span class="token punctuation">[</span>key<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> value <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span>repeatable <span class="token operator">?</span> value<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span> <span class="token operator">:</span> value
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> params
  <span class="token punctuation">}</span>

  <span class="token comment">// 根据传入的动态参数对象，转为对应的path</span>
  <span class="token keyword">function</span> <span class="token function">stringify</span><span class="token punctuation">(</span>params<span class="token operator">:</span> PathParams<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
    <span class="token comment">// for optional parameters to allow to be empty</span>
    <span class="token keyword">let</span> avoidDuplicatedSlash<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> segment <span class="token keyword">of</span> segments<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>avoidDuplicatedSlash <span class="token operator">||</span> <span class="token operator">!</span>path<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> path <span class="token operator">+=</span> <span class="token string">&#39;/&#39;</span>
      avoidDuplicatedSlash <span class="token operator">=</span> <span class="token boolean">false</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> token <span class="token keyword">of</span> segment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>type <span class="token operator">===</span> TokenType<span class="token punctuation">.</span>Static<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          path <span class="token operator">+=</span> token<span class="token punctuation">.</span>value
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>type <span class="token operator">===</span> TokenType<span class="token punctuation">.</span>Param<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> repeatable<span class="token punctuation">,</span> optional <span class="token punctuation">}</span> <span class="token operator">=</span> token
          <span class="token keyword">const</span> param<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> value <span class="token keyword">in</span> params <span class="token operator">?</span> params<span class="token punctuation">[</span>value<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&#39;&#39;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>repeatable<span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Provided param &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; is an array but it is not repeatable (* or + modifiers)</span><span class="token template-punctuation string">`</span></span>
            <span class="token punctuation">)</span>
          <span class="token keyword">const</span> text<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span> <span class="token operator">?</span> param<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span> <span class="token operator">:</span> param
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>optional<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// if we have more than one optional param like /:a?-static and there are more segments, we don&#39;t need to</span>
              <span class="token comment">// care about the optional param</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>segment<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> segments<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// remove the last slash as we could be at the end</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> path <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token comment">// do not append a slash on the next iteration</span>
                <span class="token keyword">else</span> avoidDuplicatedSlash <span class="token operator">=</span> <span class="token boolean">true</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Missing required param &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          path <span class="token operator">+=</span> text
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> path
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    re<span class="token punctuation">,</span>
    score<span class="token punctuation">,</span>
    keys<span class="token punctuation">,</span>
    parse<span class="token punctuation">,</span>
    stringify<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br></div></div><p>清楚了<code>tokensToParser</code>和<code>tokenizePath</code>，我们来看<code>createRouteRecordMatcher</code>的实现：</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRouteRecordMatcher</span><span class="token punctuation">(</span>
  record<span class="token operator">:</span> Readonly<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  parent<span class="token operator">:</span> RouteRecordMatcher <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  options<span class="token operator">?</span><span class="token operator">:</span> PathParserOptions
<span class="token punctuation">)</span><span class="token operator">:</span> RouteRecordMatcher <span class="token punctuation">{</span>
  <span class="token comment">// 生成parser对象</span>
  <span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token function">tokensToParser</span><span class="token punctuation">(</span><span class="token function">tokenizePath</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>

  <span class="token comment">// 如果有重复的动态参数命名进行提示</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> existingKeys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">of</span> parser<span class="token punctuation">.</span>keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>existingKeys<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Found duplicated params with name &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; for path &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>record<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. Only the last one will be available on &quot;$route.params&quot;.</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span>
      existingKeys<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// </span>
  <span class="token keyword">const</span> matcher<span class="token operator">:</span> RouteRecordMatcher <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    record<span class="token punctuation">,</span>
    parent<span class="token punctuation">,</span>
    <span class="token comment">// these needs to be populated by the parent</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    alias<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 两者都是alias或两者都不是alias</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matcher<span class="token punctuation">.</span>record<span class="token punctuation">.</span>aliasOf <span class="token operator">===</span> <span class="token operator">!</span>parent<span class="token punctuation">.</span>record<span class="token punctuation">.</span>aliasOf<span class="token punctuation">)</span>
      parent<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> matcher
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h3 id="resolve" tabindex="-1"><code>resolve</code> <a class="header-anchor" href="#resolve" aria-hidden="true">#</a></h3><p><code>resolve</code>根据传入的<code>location</code>进行路由匹配，找到对应的<code>matcher</code>的路由信息。方法接收一个<code>location</code>和<code>currentLocation</code>参数，返回一个<code>MatcherLocation</code>类型的对象，该对象的属性包含：<code>name</code>、<code>path</code>、<code>params</code>、<code>matched</code>、<code>meta</code>。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span>
    location<span class="token operator">:</span> Readonly<span class="token operator">&lt;</span>MatcherLocationRaw<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    currentLocation<span class="token operator">:</span> Readonly<span class="token operator">&lt;</span>MatcherLocation<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> MatcherLocation <span class="token punctuation">{</span>
    <span class="token keyword">let</span> matcher<span class="token operator">:</span> RouteRecordMatcher <span class="token operator">|</span> <span class="token keyword">undefined</span>
    <span class="token keyword">let</span> params<span class="token operator">:</span> PathParams <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">let</span> path<span class="token operator">:</span> MatcherLocation<span class="token punctuation">[</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> name<span class="token operator">:</span> MatcherLocation<span class="token punctuation">[</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span> <span class="token keyword">in</span> location <span class="token operator">&amp;&amp;</span> location<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果location存在name属性，可根据name从matcherMap获取matcher</span>
      matcher <span class="token operator">=</span> matcherMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matcher<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token generic-function"><span class="token function">createRouterError</span><span class="token generic class-name"><span class="token operator">&lt;</span>MatcherError<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ErrorTypes<span class="token punctuation">.</span><span class="token constant">MATCHER_NOT_FOUND</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          location<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

      name <span class="token operator">=</span> matcher<span class="token punctuation">.</span>record<span class="token punctuation">.</span>name
      <span class="token comment">// 合并location.params和currentLocation中的params</span>
      params <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span>
        <span class="token function">paramsFromLocation</span><span class="token punctuation">(</span>
          currentLocation<span class="token punctuation">.</span>params<span class="token punctuation">,</span>
          matcher<span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>k <span class="token operator">=&gt;</span> <span class="token operator">!</span>k<span class="token punctuation">.</span>optional<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>k <span class="token operator">=&gt;</span> k<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        location<span class="token punctuation">.</span>params
      <span class="token punctuation">)</span>
      <span class="token comment">// 如果不能通过params转为path抛出错误</span>
      path <span class="token operator">=</span> matcher<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span> <span class="token keyword">in</span> location<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果location存在path属性，根据path从matchers获取对应matcher</span>
      path <span class="token operator">=</span> location<span class="token punctuation">.</span>path

      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>path<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The Matcher cannot resolve relative paths but received &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. Unless you directly called \`matcher.resolve(&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;)\`, this is probably a bug in vue-router. Please open an issue at https://new-issue.vuejs.org/?repo=vuejs/router.</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      matcher <span class="token operator">=</span> matchers<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>m <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>re<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>matcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 通过parse函数获取params</span>
        params <span class="token operator">=</span> matcher<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token operator">!</span>
        name <span class="token operator">=</span> matcher<span class="token punctuation">.</span>record<span class="token punctuation">.</span>name
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 如果location中没有name、path属性，就使用currentLocation的name或path获取matcher</span>
      matcher <span class="token operator">=</span> currentLocation<span class="token punctuation">.</span>name
        <span class="token operator">?</span> matcherMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentLocation<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token operator">:</span> matchers<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>m <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>re<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>currentLocation<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matcher<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token generic-function"><span class="token function">createRouterError</span><span class="token generic class-name"><span class="token operator">&lt;</span>MatcherError<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ErrorTypes<span class="token punctuation">.</span><span class="token constant">MATCHER_NOT_FOUND</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          location<span class="token punctuation">,</span>
          currentLocation<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      name <span class="token operator">=</span> matcher<span class="token punctuation">.</span>record<span class="token punctuation">.</span>name
      params <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> currentLocation<span class="token punctuation">.</span>params<span class="token punctuation">,</span> location<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
      path <span class="token operator">=</span> matcher<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 使用一个数组存储匹配到的所有路由</span>
    <span class="token keyword">const</span> matched<span class="token operator">:</span> MatcherLocation<span class="token punctuation">[</span><span class="token string">&#39;matched&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> parentMatcher<span class="token operator">:</span> RouteRecordMatcher <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> matcher
    <span class="token keyword">while</span> <span class="token punctuation">(</span>parentMatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 父路由始终在数组的开头</span>
      matched<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>parentMatcher<span class="token punctuation">.</span>record<span class="token punctuation">)</span>
      parentMatcher <span class="token operator">=</span> parentMatcher<span class="token punctuation">.</span>parent
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      name<span class="token punctuation">,</span>
      path<span class="token punctuation">,</span>
      params<span class="token punctuation">,</span>
      matched<span class="token punctuation">,</span>
      meta<span class="token operator">:</span> <span class="token function">mergeMetaFields</span><span class="token punctuation">(</span>matched<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br></div></div><h3 id="removeroute" tabindex="-1"><code>removeRoute</code> <a class="header-anchor" href="#removeroute" aria-hidden="true">#</a></h3><p>删除路由。接收一个<code>matcherRef</code>参数，<code>removeRoute</code>会将<code>matcherRef</code>对应的<code>matcher</code>从<code>matcherMap</code>和<code>matchers</code>中删除，并清空<code>matcherRef</code>对应<code>matcher</code>的<code>children</code>与<code>alias</code>属性。由于<code>matcherRef</code>对应的<code>matcher</code>被删除后，其子孙及别名也就没用了，也需要把他们从<code>matcherMap</code>中和<code>matchers</code>中删除。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">function</span> <span class="token function">removeRoute</span><span class="token punctuation">(</span>matcherRef<span class="token operator">:</span> RouteRecordName <span class="token operator">|</span> RouteRecordMatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果是路由名字：string或symbol</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRouteName</span><span class="token punctuation">(</span>matcherRef<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> matcher <span class="token operator">=</span> matcherMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>matcherRef<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>matcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 删除matcher</span>
      matcherMap<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>matcherRef<span class="token punctuation">)</span>
      matchers<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>matchers<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token comment">// 清空matcher中的children与alias，</span>
      matcher<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>removeRoute<span class="token punctuation">)</span>
      matcher<span class="token punctuation">.</span>alias<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>removeRoute<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> matchers<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>matcherRef<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      matchers<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>matcherRef<span class="token punctuation">.</span>record<span class="token punctuation">.</span>name<span class="token punctuation">)</span> matcherMap<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>matcherRef<span class="token punctuation">.</span>record<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
      matcherRef<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>removeRoute<span class="token punctuation">)</span>
      matcherRef<span class="token punctuation">.</span>alias<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>removeRoute<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="getroutes" tabindex="-1"><code>getRoutes</code> <a class="header-anchor" href="#getroutes" aria-hidden="true">#</a></h3><p>获取所有<code>matcher</code>。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">function</span> <span class="token function">getRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> matchers
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="getrecordmatcher" tabindex="-1"><code>getRecordMatcher</code> <a class="header-anchor" href="#getrecordmatcher" aria-hidden="true">#</a></h3><p>根据路由名获取对应<code>matcher</code>。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">function</span> <span class="token function">getRecordMatcher</span><span class="token punctuation">(</span>name<span class="token operator">:</span> RouteRecordName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> matcherMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在<code>addRoute</code>最后调用了<code>insertMatcher</code>进行<code>matcher</code>的添加，这里我们看下是如何添加<code>marcher</code>的</p><p>在添加<code>matcher</code>时，并不是直接<code>matchers.add</code>，而是根据<code>matcher.score</code>进行排序。比较分数时根据数组中的每一项挨个比较，不是比较总分。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">function</span> <span class="token function">insertMatcher</span><span class="token punctuation">(</span>matcher<span class="token operator">:</span> RouteRecordMatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>
    i <span class="token operator">&lt;</span> matchers<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span>
    <span class="token function">comparePathParserScore</span><span class="token punctuation">(</span>matcher<span class="token punctuation">,</span> matchers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>matcher<span class="token punctuation">.</span>record<span class="token punctuation">.</span>path <span class="token operator">!==</span> matchers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>record<span class="token punctuation">.</span>path <span class="token operator">||</span>
      <span class="token operator">!</span><span class="token function">isRecordChildOf</span><span class="token punctuation">(</span>matcher<span class="token punctuation">,</span> matchers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
    i<span class="token operator">++</span>
  matchers<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> matcher<span class="token punctuation">)</span>
  <span class="token comment">// only add the original record to the name map</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>matcher<span class="token punctuation">.</span>record<span class="token punctuation">.</span>name <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isAliasRecord</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span><span class="token punctuation">)</span>
    matcherMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>matcher<span class="token punctuation">.</span>record<span class="token punctuation">.</span>name<span class="token punctuation">,</span> matcher<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">function</span> <span class="token function">compareScoreArray</span><span class="token punctuation">(</span>a<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> a<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> diff <span class="token operator">=</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>diff<span class="token punctuation">)</span> <span class="token keyword">return</span> diff

    i<span class="token operator">++</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> PathScore<span class="token punctuation">.</span>Static <span class="token operator">+</span> PathScore<span class="token punctuation">.</span>Segment
      <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span>
      <span class="token operator">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> b<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> PathScore<span class="token punctuation">.</span>Static <span class="token operator">+</span> PathScore<span class="token punctuation">.</span>Segment
      <span class="token operator">?</span> <span class="token number">1</span>
      <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">comparePathParserScore</span><span class="token punctuation">(</span>a<span class="token operator">:</span> PathParser<span class="token punctuation">,</span> b<span class="token operator">:</span> PathParser<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">const</span> aScore <span class="token operator">=</span> a<span class="token punctuation">.</span>score
  <span class="token keyword">const</span> bScore <span class="token operator">=</span> b<span class="token punctuation">.</span>score
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> aScore<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> bScore<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> comp <span class="token operator">=</span> <span class="token function">compareScoreArray</span><span class="token punctuation">(</span>aScore<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> bScore<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>comp<span class="token punctuation">)</span> <span class="token keyword">return</span> comp

    i<span class="token operator">++</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> bScore<span class="token punctuation">.</span>length <span class="token operator">-</span> aScore<span class="token punctuation">.</span>length
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>假设<code>matcherA</code>是需要添加的，<code>matchers</code>中此时只有一个<code>matcherB</code>，<code>matcherA.score=[[1, 2]]</code>，<code>matcherB.score=[[1,3]]</code>，那么<code>matcherA</code>是怎么添加到<code>matchers</code>中的呢？过程如下：</p><ol><li>初始化<code>matchers</code>索引<code>i=0</code></li><li>首先比较<code>matcherA.score[0][0]</code>与<code>matcherB.score[0][0]</code>，<code>matcherB.score[0][0]-matcherA.score[0][0] === 0</code>继续比较</li><li><code>matcherA.score[0][1]</code>与<code>matcherB.score[0][1]</code>，因为<code>matcherB.score[0][1]-matcherA.score[0][1] &gt; 0</code>，<code>i++</code></li><li><code>i=1</code>时，由于<code>i=matchers.length</code>，结束循环</li><li>执行<code>matchers.splice(i, 0, matcher)</code>，此时<code>i=1</code>,所以<code>matcherA</code>会被添加到索引为1的位置</li></ol><p>如果<code>matcherA.score=[[1,3,4]]</code>呢？ 在比较时因为前两个索引对应的值都是一样的，这时会进入<code>compareScoreArray</code>的以下分支：</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> b<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> PathScore<span class="token punctuation">.</span>Static <span class="token operator">+</span> PathScore<span class="token punctuation">.</span>Segment
    <span class="token operator">?</span> <span class="token number">1</span>
    <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>以上结果返回-1，<code>matcherA</code>会被添加到索引为0的位置。</p><p>如果<code>matcherA.score=[[1]]</code>，进入<code>compareScoreArray</code>的以下分支：</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> PathScore<span class="token punctuation">.</span>Static <span class="token operator">+</span> PathScore<span class="token punctuation">.</span>Segment
    <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>因为<code>matcherA.score[0].length === 1</code>，这时就需要考虑<code>token</code>的类型里，假设<code>token</code>是个<code>Static</code>类型的，那么返回-1，<code>matcherA</code>添加到索引为0的位置。如果<code>token</code>不是<code>Static</code>类型的，返回1，<code>matcherA</code>添加到索引为1的位置</p><p><strong>总结</strong></p><p>经过上面分析，我们知道了<code>routerMatcher</code>是什么，如何实现的</p><p><code>routerMatcher</code>中通过维护一个<code>matchers</code>、<code>matcherMap</code>来实现对<code>matcher</code>的增删改查，其中<code>matchers</code>中是按<code>score</code>进行了排序，<code>matcherMap</code>中的<code>key</code>是注册路由时路由表的<code>name</code>。</p><p><code>matchers</code>、<code>matcherMap</code>存储的是<code>RouteRecordMatcher</code>，<code>RouteRecordMatcher</code>中包含了路由<code>path</code>对应的正则<code>re</code>、路由的分数<code>score</code>、动态参数列表<code>keys</code>、可从<code>path</code>中提取动态参数的<code>parse(path)</code>函数、可传入参数对象将其转为对应<code>path</code>的<code>stringify(param)</code>函数、父<code>matcher</code>（<code>parent</code>）、路由的标准化版本<code>record</code>、子<code>matcher</code>（<code>children</code>）、由别名产生的<code>matcher</code>（<code>alias</code>）</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">PathParser</span> <span class="token punctuation">{</span>
  re<span class="token operator">:</span> RegExp
  score<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
  keys<span class="token operator">:</span> PathParserParamKey<span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token function">parse</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> PathParams <span class="token operator">|</span> <span class="token keyword">null</span>
  <span class="token function">stringify</span><span class="token punctuation">(</span>params<span class="token operator">:</span> PathParams<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">RouteRecordMatcher</span> <span class="token keyword">extends</span> <span class="token class-name">PathParser</span> <span class="token punctuation">{</span>
  record<span class="token operator">:</span> RouteRecord
  parent<span class="token operator">:</span> RouteRecordMatcher <span class="token operator">|</span> <span class="token keyword">undefined</span>
  children<span class="token operator">:</span> RouteRecordMatcher<span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// aliases that must be removed when removing this record</span>
  alias<span class="token operator">:</span> RouteRecordMatcher<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>在生成<code>RouteRecordMatcher</code>的过程中会将<code>path</code>转换成<code>token</code>数组（二维数组，第一维度中每个维度代表一级路由，第二维度中每个维度代表路由的组成），路由正则的生成、动态参数的提取、分数的计算、<code>stringify</code>全都依托这个<code>token</code>数组实现</p></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-07c132fc><div class="edit" data-v-07c132fc><div class="edit-link" data-v-07c132fc data-v-1ed99556><a class="link" href="https://github.com/MAXLZ1/blog/edit/main/docs/vue-router/routerMatcher.md" target="_blank" rel="noopener noreferrer" data-v-1ed99556>纠正文档 <svg class="icon outbound icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-1ed99556><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="updated" data-v-07c132fc><!----></div></footer><div class="next-and-prev-link" data-v-7eddb2c4 data-v-38ede35f><div class="container" data-v-38ede35f><div class="prev" data-v-38ede35f><a class="link" href="/blog/vue-router/createMemoryHistory" data-v-38ede35f><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-prev" data-v-38ede35f><path d="M19,11H7.4l5.3-5.3c0.4-0.4,0.4-1,0-1.4s-1-0.4-1.4,0l-7,7c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.2-0.1,0.5,0,0.8c0.1,0.1,0.1,0.2,0.2,0.3l7,7c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3c0.4-0.4,0.4-1,0-1.4L7.4,13H19c0.6,0,1-0.4,1-1S19.6,11,19,11z"></path></svg><span class="text" data-v-38ede35f>createMemoryHistory</span></a></div><div class="next" data-v-38ede35f><a class="link" href="/blog/vue-router/createRouter" data-v-38ede35f><span class="text" data-v-38ede35f>createRouter</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-38ede35f><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"index.md\":\"e21a6ed4\",\"pinia_createpinia.md\":\"b1a06df6\",\"pinia_definestore.md\":\"c0b88d43\",\"pinia_maphelper.md\":\"1c652bf3\",\"pinia_mapstate、mapactions.md\":\"1195076c\",\"pinia_mapstores.md\":\"a523d8ce\",\"pinia_mapwritablestate.md\":\"a9011f6b\",\"pinia_preface.md\":\"6e1d488b\",\"pinia_storetorefs.md\":\"d9dc4e8d\",\"vue-router_addroute.md\":\"0acde771\",\"vue-router_back、forward.md\":\"95cf2a58\",\"vue-router_creatememoryhistory.md\":\"c31a8154\",\"vue-router_createrouter.md\":\"b2511003\",\"vue-router_createwebhashhistory.md\":\"d6f78f9f\",\"vue-router_createwebhistory.md\":\"7385f4e6\",\"vue-router_getroutes.md\":\"f76068fe\",\"vue-router_go.md\":\"d63f7d33\",\"vue-router_hasroute.md\":\"b20fc15b\",\"vue-router_isready.md\":\"55fdb59f\",\"vue-router_preface.md\":\"44a7fa20\",\"vue-router_push.md\":\"694d5c7e\",\"vue-router_removeroute.md\":\"203bf762\",\"vue-router_replace.md\":\"14161523\",\"vue-router_resolve.md\":\"f7fdd187\",\"vue-router_router-install.md\":\"2f154bba\",\"vue-router_router-link.md\":\"eb346003\",\"vue-router_router-view.md\":\"97d0c823\",\"vue-router_routermatcher.md\":\"6c507e29\",\"vue-router_uselink.md\":\"b5bbd943\",\"vue-router_useroute、userouter.md\":\"c04c3288\",\"vue-router_全局导航守卫.md\":\"5d575310\",\"vue-router_总结.md\":\"dfcca235\",\"vue-router_组件内导航守卫.md\":\"7973ac2a\",\"vue3-analysis_computed.md\":\"d1998c53\",\"vue3-analysis_effect_依赖收集.md\":\"fa2cc57a\",\"vue3-analysis_effect_触发依赖.md\":\"e2fd0342\",\"vue3-analysis_reactive_reactive.md\":\"f9bf0141\",\"vue3-analysis_reactive_readonly.md\":\"ad55c95c\",\"vue3-analysis_reactive_shallowreactive.md\":\"2f2568c7\",\"vue3-analysis_reactive_shallowreadonly.md\":\"7496829c\",\"vue3-analysis_reactive_toraw.md\":\"5c93cde3\",\"vue3-analysis_refs_customref.md\":\"d249353c\",\"vue3-analysis_refs_ref.md\":\"a5040632\",\"vue3-analysis_refs_shallowref.md\":\"019c306f\",\"vue3-analysis_structure.md\":\"76764dce\",\"vue3-analysis_watch_watch.md\":\"5214720f\"}")</script>
    <script type="module" async src="/blog/assets/app.d2a36d2c.js"></script>
    
  </body>
</html>